# GitHub Actions 工作流: 自动化测试
# 学习要点:
# - on: 定义触发条件 (push, pull_request)
# - jobs: 定义执行任务 (测试, 安全扫描, 覆盖率上传)
# - runs-on: 指定运行环境 (ubuntu-latest)

name: Test Suite

# 触发条件
on:
  push:
    branches: [main, develop]  # 推送到 main 或 develop 分支
  pull_request:
    branches: [main, develop]  # 针对 main 或 develop 的 PR

# 环境变量 (所有 jobs 共享)
env:
  SECRET_KEY: test-secret-key-with-sufficient-length-32-bytes-minimum-requirement
  ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
  DATABASE_URL: sqlite:///:memory:

jobs:
  # ========================================
  # Job 1: 单元测试和集成测试
  # ========================================
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]  # 匹配开发环境 Python 版本

    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 步骤 2: 设置 Python 环境
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # 步骤 3: 缓存依赖 (加速后续运行)
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 步骤 4: 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      # 步骤 5: 运行单元测试 (快速反馈)
      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short --cov=app --cov-report=xml --cov-report=term

      # 步骤 6: 运行集成测试
      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --tb=short

      # 步骤 7: 上传覆盖率报告到 Codecov (可选)
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false  # 即使上传失败也不阻塞 CI

  # ========================================
  # Job 2: 黄金文件测试
  # ========================================
  golden-test:
    name: Golden File Tests
    runs-on: ubuntu-latest
    needs: test  # 依赖 test job 完成

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      # 加载黄金基准文件 (如果存在)
      - name: Restore golden baselines
        uses: actions/cache@v3
        with:
          path: tests/golden/baselines/
          key: golden-baselines-${{ hashFiles('tests/golden/baselines/*.json') }}
          restore-keys: |
            golden-baselines-

      # 运行黄金测试 (验证模式)
      - name: Run golden tests
        run: |
          pytest tests/golden/ -v --tb=short

      # 上传差异报告 (如果测试失败)
      - name: Upload diff report
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: golden-diff-report
          path: tests/golden/diff_report.html
          retention-days: 7

  # ========================================
  # Job 3: 安全扫描
  # ========================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      # 运行 bandit 静态安全扫描
      - name: Run bandit security scan
        run: |
          bandit -r app/ -ll -f json -o bandit-report.json
        continue-on-error: true  # 允许有中等风险, 仅 High 风险阻塞

      # 检查依赖漏洞
      - name: Check dependency vulnerabilities
        run: |
          safety check --json --output safety-report.json
        continue-on-error: true

      # 上传安全扫描报告
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  # ========================================
  # Job 4: 代码质量检查
  # ========================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install black flake8 mypy

      # 代码格式化检查 (black)
      - name: Check code formatting
        run: |
          black --check app/ tests/

      # 代码风格检查 (flake8)
      - name: Run flake8
        run: |
          flake8 app/ tests/ --max-line-length=120 --extend-ignore=E203,W503

      # 类型检查 (mypy)
      - name: Run type checks
        run: |
          mypy app/ --ignore-missing-imports
        continue-on-error: true  # mypy 错误不阻塞, 仅警告

# ========================================
# 学习要点总结
# ========================================

# 1. 工作流触发:
#    - push: 代码推送到指定分支自动触发
#    - pull_request: PR 创建或更新时触发
#    - schedule: 定时触发 (如每日安全扫描)

# 2. Jobs 并行执行:
#    - test, security-scan, code-quality 并行运行 (加速 CI)
#    - golden-test 依赖 test 完成后运行 (needs: test)

# 3. 质量门禁:
#    - 单元测试覆盖率 ≥ 70% (pytest --cov-fail-under=70)
#    - bandit 扫描 0 个 High 风险
#    - 代码格式化通过 (black --check)

# 4. 缓存优化:
#    - pip 依赖缓存: 加速后续运行
#    - golden baselines 缓存: 避免重复生成

# 5. 失败处理:
#    - continue-on-error: 允许部分任务失败不阻塞 CI
#    - if: failure(): 仅在失败时执行 (如上传 diff 报告)

# 6. Artifacts 上传:
#    - 测试报告: coverage.xml
#    - 安全扫描: bandit-report.json, safety-report.json
#    - 差异报告: golden-diff-report.html

# 7. 为什么重要:
#    - 自动化测试: 每次代码变更自动验证
#    - 早期发现问题: 在 PR 合并前发现 bug
#    - 质量保证: 强制通过测试才能合并
#    - 安全保障: 自动检测安全漏洞
