{
  "id": "IMPL-008",
  "title": "测试与验证编辑功能",
  "status": "pending",
  "meta": {
    "type": "test",
    "agent": "@code-developer",
    "priority": "high",
    "estimated_complexity": "medium",
    "affected_files": [
      "test/widgets/note_content_editor_test.dart",
      "test/widgets/markdown_source_editor_test.dart",
      "test/utils/delta_markdown_converter_test.dart"
    ],
    "dependencies": ["IMPL-007"]
  },
  "context": {
    "requirements": [
      "创建 3 个测试文件: [note_content_editor_test.dart, markdown_source_editor_test.dart, delta_markdown_converter_test.dart]",
      "编写 15+ 测试用例覆盖 5 个功能: [模式切换, 内容同步, 保存功能, Delta-Markdown 转换, LaTeX 渲染]",
      "执行集成测试验证完整编辑流程"
    ],
    "focus_paths": ["test/", "lib/presentation/", "lib/utils/"],
    "acceptance": [
      "单元测试通过: 验证 flutter test 执行成功（exit code 0）",
      "测试覆盖率 ≥80%: 验证 flutter test --coverage 报告覆盖率",
      "集成测试通过: 验证完整编辑流程（预览 -> 编辑 -> 保存 -> 预览）正常",
      "LaTeX 渲染验证: 验证 $x^2$ 和 $$\\sum$$ 在各模式下显示正确"
    ],
    "description": "创建全面的测试用例验证笔记编辑功能的正确性，包括模式切换、内容同步、格式转换和 LaTeX 支持",
    "technical_notes": [
      "使用 flutter_test 包编写测试",
      "使用 mockito 模拟 API 调用",
      "测试 Delta-Markdown 转换的双向一致性",
      "测试 LaTeX 公式在转换中是否保留",
      "测试边界情况（空内容、特殊字符等）"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "analyze_test_patterns",
        "commands": [
          "bash(find ../frontend/test -name '*_test.dart' -type f | head -5)",
          "bash(rg 'testWidgets|test\\(' ../frontend/test/ --type dart -n --max-count 10)"
        ],
        "output_to": "test_patterns",
        "on_error": "skip_optional"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建 Delta-Markdown 转换工具测试",
        "description": "测试双向转换的正确性和一致性",
        "modification_points": [
          "创建 1 个文件: test/utils/delta_markdown_converter_test.dart (约 150 行)",
          "编写 8 个测试用例: [粗体转换, 斜体转换, 标题转换, 列表转换, 代码块转换, LaTeX inline 转换, LaTeX block 转换, 双向一致性]"
        ],
        "logic_flow": [
          "测试 Markdown -> Delta -> Markdown 往返转换",
          "验证 LaTeX 公式 $x^2$ 保留正确",
          "验证 LaTeX 公式 $$\\sum_{i=1}^n$$ 保留正确",
          "测试嵌套格式（如粗体+斜体）",
          "测试边界情况（空字符串、特殊字符）"
        ],
        "depends_on": [],
        "output": "converter_tests"
      },
      {
        "step": 2,
        "title": "创建 WYSIWYG 编辑器组件测试",
        "description": "测试 NoteContentEditor 组件功能",
        "modification_points": [
          "创建 1 个文件: test/widgets/note_content_editor_test.dart (约 120 行)",
          "编写 5 个测试用例: [组件渲染, 内容加载, 内容提取, 工具栏交互, 内容变化回调]"
        ],
        "logic_flow": [
          "测试组件渲染成功",
          "测试初始 Markdown 内容加载",
          "测试 getMarkdownContent() 返回正确内容",
          "测试工具栏按钮触发格式化",
          "测试 onContentChanged 回调触发"
        ],
        "depends_on": [],
        "output": "wysiwyg_tests"
      },
      {
        "step": 3,
        "title": "创建 Markdown 源码编辑器测试",
        "description": "测试 MarkdownSourceEditor 组件功能",
        "modification_points": [
          "创建 1 个文件: test/widgets/markdown_source_editor_test.dart (约 80 行)",
          "编写 4 个测试用例: [组件渲染, 内容加载, 内容提取, 等宽字体应用]"
        ],
        "logic_flow": [
          "测试组件渲染成功",
          "测试初始内容加载到 TextFormField",
          "测试 getContent() 返回编辑后内容",
          "验证 TextStyle 使用 monospace 字体"
        ],
        "depends_on": [],
        "output": "markdown_editor_tests"
      },
      {
        "step": 4,
        "title": "执行集成测试",
        "description": "测试完整编辑流程",
        "modification_points": [
          "手动测试或编写 integration_test（约 100 行）",
          "测试完整流程: [打开详情页 -> 切换到 WYSIWYG -> 编辑内容 -> 保存 -> 切换到预览 -> 验证内容]"
        ],
        "logic_flow": [
          "模拟用户打开笔记详情页",
          "切换到 WYSIWYG 编辑模式",
          "输入包含 LaTeX 的内容",
          "点击保存按钮",
          "切换回预览模式",
          "验证内容和 LaTeX 渲染正确"
        ],
        "depends_on": [1, 2, 3],
        "output": "integration_tests"
      },
      {
        "step": 5,
        "title": "运行测试并生成覆盖率报告",
        "description": "执行所有测试并验证覆盖率",
        "modification_points": [
          "执行命令: flutter test --coverage",
          "生成 HTML 报告: genhtml coverage/lcov.info -o coverage/html",
          "验证核心模块覆盖率 ≥80%"
        ],
        "logic_flow": [
          "运行 flutter test 验证所有测试通过",
          "运行 flutter test --coverage 生成覆盖率",
          "分析覆盖率报告，识别未覆盖代码",
          "补充测试用例提高覆盖率（如需要）"
        ],
        "depends_on": [4],
        "output": "coverage_report"
      }
    ],
    "target_files": [
      "test/utils/delta_markdown_converter_test.dart",
      "test/widgets/note_content_editor_test.dart",
      "test/widgets/markdown_source_editor_test.dart"
    ],
    "depends_on": ["IMPL-007"],
    "blocks": []
  }
}
