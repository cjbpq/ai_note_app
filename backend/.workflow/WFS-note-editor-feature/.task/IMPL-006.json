{
  "id": "IMPL-006",
  "title": "改造详情页 - 添加模式切换 UI",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "priority": "high",
    "estimated_complexity": "medium",
    "affected_files": ["lib/presentation/pages/notes/note_detail_page.dart"],
    "dependencies": ["IMPL-002", "IMPL-004", "IMPL-005"]
  },
  "context": {
    "requirements": [
      "修改 1 个文件: note_detail_page.dart 的 AppBar 部分",
      "添加 1 个切换按钮: 在 AppBar actions 中添加模式切换按钮",
      "实现 3 种模式切换: [预览模式, WYSIWYG 编辑, Markdown 源码编辑]",
      "集成 noteDetailProvider 的 editMode 状态"
    ],
    "focus_paths": ["lib/presentation/pages/notes/"],
    "acceptance": [
      "切换按钮显示: 验证 AppBar 包含模式切换按钮",
      "3 种模式可选: 验证点击按钮显示 3 个选项",
      "模式切换生效: 验证选择不同模式时 editMode 状态更新",
      "UI 响应状态: 验证状态变化时 UI 重新渲染"
    ],
    "description": "在笔记详情页的 AppBar 中添加编辑模式切换功能，支持在预览、WYSIWYG 编辑、Markdown 源码编辑三种模式间切换",
    "technical_notes": [
      "使用 PopupMenuButton 或 SegmentedButton 实现模式选择",
      "集成 flutter_riverpod 读取和更新 editMode 状态",
      "切换模式时需要确认是否保存当前编辑内容（可选）",
      "考虑模式切换动画和过渡效果"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "analyze_detail_page",
        "commands": [
          "bash(rg 'AppBar|actions' ../frontend/lib/presentation/pages/notes/note_detail_page.dart -n --max-count 15)"
        ],
        "output_to": "detail_page_structure",
        "on_error": "skip_optional"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "添加模式切换按钮到 AppBar",
        "description": "在 AppBar actions 中添加 PopupMenuButton",
        "modification_points": [
          "修改 note_detail_page.dart AppBar 部分（约 30 行新增）",
          "在 actions 列表添加 1 个 PopupMenuButton",
          "配置 3 个菜单项: [预览, WYSIWYG 编辑, Markdown 编辑]"
        ],
        "logic_flow": [
          "在 AppBar actions 中添加 PopupMenuButton",
          "使用 Icon(Icons.edit_note) 作为按钮图标",
          "定义 3 个 PopupMenuItem 对应 3 种模式",
          "为每个菜单项设置对应的 NoteEditMode 值"
        ],
        "depends_on": [],
        "output": "mode_switch_button"
      },
      {
        "step": 2,
        "title": "集成 editMode 状态",
        "description": "使用 riverpod 读取和更新 editMode",
        "modification_points": [
          "使用 ConsumerWidget 或 Consumer 包装 AppBar（如果尚未）",
          "读取 noteDetailProvider 的 editMode 状态",
          "在 PopupMenuButton.onSelected 中调用 switchEditMode()"
        ],
        "logic_flow": [
          "使用 ref.watch(noteDetailProvider) 监听状态",
          "在菜单项选中时调用 ref.read(noteDetailProvider.notifier).switchEditMode()",
          "根据当前 editMode 高亮对应菜单项（添加 checkmark）"
        ],
        "depends_on": [1],
        "output": "state_integration"
      },
      {
        "step": 3,
        "title": "添加模式切换确认逻辑",
        "description": "在切换模式前检查是否有未保存的编辑内容",
        "modification_points": [
          "在 onSelected 回调中添加确认逻辑（约 20 行）",
          "如果 isEditing 为 true，显示确认对话框",
          "确认后执行模式切换"
        ],
        "logic_flow": [
          "检查 noteDetailProvider.isEditing 状态",
          "如果正在编辑，显示 AlertDialog 确认",
          "用户确认后调用 switchEditMode()",
          "用户取消则保持当前模式"
        ],
        "depends_on": [2],
        "output": "confirmation_logic"
      }
    ],
    "target_files": [
      "lib/presentation/pages/notes/note_detail_page.dart:AppBar:50-100"
    ],
    "depends_on": ["IMPL-002", "IMPL-004", "IMPL-005"],
    "blocks": ["IMPL-007"]
  }
}
