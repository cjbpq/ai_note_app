{
  "id": "IMPL-007",
  "title": "改造详情页 - 实现内容区域模式切换",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "priority": "high",
    "estimated_complexity": "high",
    "affected_files": ["lib/presentation/pages/notes/note_detail_page.dart"],
    "dependencies": ["IMPL-002", "IMPL-004", "IMPL-005", "IMPL-006"]
  },
  "context": {
    "requirements": [
      "修改 1 个文件: note_detail_page.dart 的 body 内容区域",
      "实现 3 种内容渲染: [LatexMarkdown 预览, NoteContentEditor WYSIWYG, MarkdownSourceEditor 源码]",
      "添加 2 个功能: [保存按钮, 自动保存逻辑]",
      "处理 3 种模式间的内容同步"
    ],
    "focus_paths": ["lib/presentation/pages/notes/note_detail_page.dart"],
    "acceptance": [
      "条件渲染正常: 验证根据 editMode 渲染不同组件",
      "内容同步正确: 验证模式切换时内容保持一致",
      "保存功能有效: 验证保存按钮更新 original_text 到后端",
      "自动保存生效: 验证编辑停止 3 秒后自动保存（可选）"
    ],
    "description": "改造笔记详情页的内容区域，根据编辑模式动态渲染不同的组件，并实现内容同步和保存功能",
    "technical_notes": [
      "使用条件语句（switch 或 if-else）根据 editMode 渲染组件",
      "需要管理每个编辑器的 GlobalKey 以访问其方法",
      "模式切换时需要保存当前编辑器内容并加载到新编辑器",
      "保存时调用 API 更新 original_text 字段",
      "考虑使用 debounce 实现自动保存（避免频繁请求）"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "analyze_content_area",
        "commands": [
          "bash(rg 'LatexMarkdown|body:' ../frontend/lib/presentation/pages/notes/note_detail_page.dart -n -A 10)"
        ],
        "output_to": "content_area_structure",
        "on_error": "skip_optional"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "实现条件渲染逻辑",
        "description": "根据 editMode 渲染不同的 Widget",
        "modification_points": [
          "修改 note_detail_page.dart body 部分（约 80 行改动）",
          "使用 switch 语句根据 editMode 返回不同 Widget",
          "3 种情况: [NoteEditMode.preview -> LatexMarkdown, NoteEditMode.wysiwyg -> NoteContentEditor, NoteEditMode.markdown -> MarkdownSourceEditor]"
        ],
        "logic_flow": [
          "在 build 方法中读取 noteDetailProvider.editMode",
          "使用 switch 语句判断模式",
          "preview 模式渲染 LatexMarkdown（现有组件）",
          "wysiwyg 模式渲染 NoteContentEditor",
          "markdown 模式渲染 MarkdownSourceEditor",
          "为每个编辑器组件分配 GlobalKey"
        ],
        "depends_on": [],
        "output": "conditional_rendering"
      },
      {
        "step": 2,
        "title": "实现内容同步机制",
        "description": "在模式切换时保存和加载内容",
        "modification_points": [
          "在 State 类中添加 3 个 GlobalKey: [_wysiwygKey, _markdownKey]",
          "在 switchEditMode() 调用前提取当前编辑器内容",
          "在新编辑器渲染时传入最新内容"
        ],
        "logic_flow": [
          "定义 String _currentContent 存储当前编辑内容",
          "模式切换前调用当前编辑器的 getContent() 方法",
          "将内容保存到 _currentContent",
          "新编辑器初始化时传入 _currentContent",
          "确保内容在 3 种模式间无损传递"
        ],
        "depends_on": [1],
        "output": "content_sync"
      },
      {
        "step": 3,
        "title": "添加保存按钮和保存逻辑",
        "description": "在编辑模式下显示保存按钮",
        "modification_points": [
          "在 AppBar actions 中添加保存按钮（条件渲染）",
          "实现 _saveNote() 方法调用 API（约 30 行）",
          "更新 original_text 字段到后端"
        ],
        "logic_flow": [
          "当 isEditing 为 true 时显示保存按钮",
          "点击保存时提取当前编辑器内容",
          "调用 noteDetailProvider.updateNote() 方法",
          "传递 {original_text: content} 到 API",
          "保存成功后显示 SnackBar 提示",
          "保存失败显示错误信息"
        ],
        "depends_on": [2],
        "output": "save_functionality"
      },
      {
        "step": 4,
        "title": "实现自动保存（可选）",
        "description": "编辑停止一定时间后自动保存",
        "modification_points": [
          "添加 Timer? _autoSaveTimer 字段",
          "在 onContentChanged 回调中重置 timer（约 20 行）",
          "3 秒后触发自动保存"
        ],
        "logic_flow": [
          "监听编辑器的 onContentChanged 回调",
          "取消现有的 _autoSaveTimer",
          "创建新的 Timer(Duration(seconds: 3))",
          "Timer 触发时调用 _saveNote()",
          "在 dispose 中取消 timer"
        ],
        "depends_on": [3],
        "output": "auto_save"
      }
    ],
    "target_files": [
      "lib/presentation/pages/notes/note_detail_page.dart:body:100-300"
    ],
    "depends_on": ["IMPL-002", "IMPL-004", "IMPL-005", "IMPL-006"],
    "blocks": ["IMPL-008"]
  }
}
