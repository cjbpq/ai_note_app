{
  "id": "IMPL-003",
  "title": "创建 Delta-Markdown 转换工具",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "priority": "high",
    "estimated_complexity": "high",
    "affected_files": ["lib/utils/delta_markdown_converter.dart"],
    "dependencies": ["IMPL-001"]
  },
  "context": {
    "requirements": [
      "创建 1 个转换工具类: DeltaMarkdownConverter",
      "实现 2 个转换方法: [deltaToMarkdown() 从 Delta 转为 Markdown, markdownToDelta() 从 Markdown 转为 Delta]",
      "支持 6 种格式: [粗体, 斜体, 标题, 列表, 代码块, LaTeX 公式]"
    ],
    "focus_paths": ["lib/utils/"],
    "acceptance": [
      "转换类创建成功: 验证 DeltaMarkdownConverter 类存在",
      "双向转换实现: 验证 2 个转换方法可以正常调用",
      "格式支持完整: 验证 6 种格式转换正确性（单元测试）",
      "LaTeX 保留: 验证 $...$ 和 $$...$$ 公式标记在转换中保持不变"
    ],
    "description": "创建 Quill Delta 格式与 Markdown 文本之间的双向转换工具，确保编辑内容在不同模式下无损转换",
    "technical_notes": [
      "Delta 格式是 Quill 编辑器的内部数据结构（JSON）",
      "需要处理富文本属性到 Markdown 语法的映射",
      "LaTeX 公式需要特殊处理：$inline$ 和 $$block$$",
      "考虑使用 flutter_quill 的 DeltaToMarkdown 工具类",
      "需要处理嵌套结构（如列表内的粗体文本）"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "research_delta_format",
        "commands": [
          "bash(rg 'Delta|Quill' ../frontend/lib/ --type dart -n --max-count 10)"
        ],
        "output_to": "delta_usage",
        "on_error": "skip_optional"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建转换工具类骨架",
        "description": "定义 DeltaMarkdownConverter 类和方法签名",
        "modification_points": [
          "创建 1 个文件: lib/utils/delta_markdown_converter.dart (约 150 行)",
          "定义 2 个静态方法: [deltaToMarkdown(Delta delta), markdownToDelta(String markdown)]"
        ],
        "logic_flow": [
          "创建 delta_markdown_converter.dart 文件",
          "导入 flutter_quill 和 markdown 包",
          "定义 DeltaMarkdownConverter 类",
          "声明转换方法签名"
        ],
        "depends_on": [],
        "output": "converter_skeleton"
      },
      {
        "step": 2,
        "title": "实现 Delta 到 Markdown 转换",
        "description": "遍历 Delta operations，生成 Markdown 文本",
        "modification_points": [
          "实现 deltaToMarkdown() 方法（约 70 行）",
          "处理 6 种格式转换: [bold -> **, italic -> *, header -> #, list -> -, code -> ```, LaTeX -> $ 或 $$]"
        ],
        "logic_flow": [
          "遍历 Delta 的 operations 列表",
          "根据 attributes 生成 Markdown 标记",
          "处理嵌套属性（如粗体+斜体 -> ***）",
          "特殊处理 LaTeX 公式（保留 $ 标记）",
          "拼接生成最终 Markdown 字符串"
        ],
        "depends_on": [1],
        "output": "delta_to_markdown"
      },
      {
        "step": 3,
        "title": "实现 Markdown 到 Delta 转换",
        "description": "解析 Markdown 语法，构建 Delta operations",
        "modification_points": [
          "实现 markdownToDelta() 方法（约 80 行）",
          "使用 markdown 包解析或正则匹配 6 种格式"
        ],
        "logic_flow": [
          "解析 Markdown 文本（使用 markdown 包或正则）",
          "识别 Markdown 标记（**, *, #, -, ```, $）",
          "构建 Delta operations 数组",
          "处理 LaTeX 公式（保留 $ 标记作为纯文本）",
          "返回 Delta 对象"
        ],
        "depends_on": [1],
        "output": "markdown_to_delta"
      }
    ],
    "target_files": [
      "lib/utils/delta_markdown_converter.dart"
    ],
    "depends_on": ["IMPL-001"],
    "blocks": ["IMPL-004", "IMPL-005"]
  }
}
