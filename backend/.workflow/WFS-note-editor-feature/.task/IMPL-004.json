{
  "id": "IMPL-004",
  "title": "创建 WYSIWYG 编辑器组件",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "priority": "high",
    "estimated_complexity": "medium",
    "affected_files": ["lib/presentation/widgets/note_content_editor.dart"],
    "dependencies": ["IMPL-001", "IMPL-003"]
  },
  "context": {
    "requirements": [
      "创建 1 个 Widget: NoteContentEditor 封装 flutter_quill 编辑器",
      "集成 3 个组件: [QuillController, QuillToolbar, QuillEditor]",
      "实现 4 个功能: [内容加载, 内容提取, Delta-Markdown 转换, 工具栏配置]"
    ],
    "focus_paths": ["lib/presentation/widgets/"],
    "acceptance": [
      "组件创建成功: 验证 NoteContentEditor widget 存在",
      "编辑器渲染正常: 验证 QuillEditor 可以显示和编辑内容",
      "工具栏功能完整: 验证工具栏包含粗体、斜体、标题、列表、代码块按钮",
      "内容转换正确: 验证加载 Markdown 显示正确，提取时转换为 Markdown"
    ],
    "description": "创建封装 flutter_quill 的 WYSIWYG 编辑器组件，提供富文本编辑能力和 Markdown 双向转换接口",
    "technical_notes": [
      "使用 QuillController 管理编辑器状态",
      "工具栏应包含：粗体、斜体、标题、列表、代码块等常用功能",
      "初始化时调用 markdownToDelta() 加载内容",
      "提供 getMarkdownContent() 方法提取内容",
      "考虑工具栏的响应式布局（移动端友好）"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "analyze_widget_patterns",
        "commands": [
          "bash(rg 'StatefulWidget|ConsumerWidget' ../frontend/lib/presentation/widgets/ --type dart -n --max-count 15)"
        ],
        "output_to": "widget_patterns",
        "on_error": "skip_optional"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建 Widget 骨架",
        "description": "定义 NoteContentEditor StatefulWidget",
        "modification_points": [
          "创建 1 个文件: lib/presentation/widgets/note_content_editor.dart (约 200 行)",
          "定义 NoteContentEditor 类和 State 类",
          "添加构造函数参数: [initialMarkdown, onContentChanged]"
        ],
        "logic_flow": [
          "创建 note_content_editor.dart 文件",
          "定义 StatefulWidget 和 State 类",
          "声明 QuillController 和生命周期方法",
          "定义回调函数签名"
        ],
        "depends_on": [],
        "output": "widget_skeleton"
      },
      {
        "step": 2,
        "title": "实现编辑器初始化和内容加载",
        "description": "在 initState 中初始化 QuillController 并加载内容",
        "modification_points": [
          "实现 initState() 方法（约 20 行）",
          "调用 DeltaMarkdownConverter.markdownToDelta() 转换初始内容",
          "创建 QuillController 并设置 Document"
        ],
        "logic_flow": [
          "在 initState 中初始化 QuillController",
          "将 initialMarkdown 转换为 Delta",
          "使用 Delta 创建 QuillDocument",
          "监听 controller 变化触发 onContentChanged"
        ],
        "depends_on": [1],
        "output": "editor_initialization"
      },
      {
        "step": 3,
        "title": "构建编辑器 UI",
        "description": "在 build 方法中组合 QuillToolbar 和 QuillEditor",
        "modification_points": [
          "实现 build() 方法（约 80 行）",
          "配置 QuillToolbar 包含 6 个按钮组: [粗体/斜体, 标题, 列表, 代码块, 撤销/重做, 清除格式]",
          "配置 QuillEditor 支持滚动和自适应高度"
        ],
        "logic_flow": [
          "使用 Column 布局 toolbar 和 editor",
          "配置 QuillToolbar 按钮（简洁工具栏）",
          "配置 QuillEditor 属性（padding, 滚动等）",
          "添加边框和样式美化"
        ],
        "depends_on": [2],
        "output": "editor_ui"
      },
      {
        "step": 4,
        "title": "实现内容提取方法",
        "description": "提供 getMarkdownContent() 方法供外部调用",
        "modification_points": [
          "添加 1 个方法: getMarkdownContent() 返回 String",
          "调用 DeltaMarkdownConverter.deltaToMarkdown() 转换"
        ],
        "logic_flow": [
          "从 QuillController 获取当前 Document",
          "将 Document 转换为 Delta",
          "调用 deltaToMarkdown() 转换",
          "返回 Markdown 字符串"
        ],
        "depends_on": [3],
        "output": "content_extraction"
      }
    ],
    "target_files": [
      "lib/presentation/widgets/note_content_editor.dart"
    ],
    "depends_on": ["IMPL-001", "IMPL-003"],
    "blocks": ["IMPL-006", "IMPL-007"]
  }
}
