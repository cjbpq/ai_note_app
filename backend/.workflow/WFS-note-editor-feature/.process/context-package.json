{
  "metadata": {
    "task_description": "实现笔记编辑功能，类似Obsidian和Notion的编辑体验。当前笔记正文模块完全无法编辑，需要实现完整的编辑功能，包括富文本编辑、Markdown支持、实时预览。",
    "timestamp": "2025-12-15T08:30:00Z",
    "keywords": [
      "note",
      "editor",
      "markdown",
      "content",
      "text",
      "rich-text",
      "editing",
      "wysiwyg",
      "flutter_quill",
      "super_editor",
      "structured_data"
    ],
    "complexity": "complex",
    "session_id": "WFS-note-editor-feature",
    "tech_stack": {
      "frontend": {
        "language": "Dart",
        "framework": "Flutter 3.10.4",
        "state_management": "flutter_riverpod 2.6.1",
        "rendering": "flutter_markdown 0.7.4+3",
        "navigation": "go_router 14.6.2"
      },
      "backend": {
        "language": "Python 3.12",
        "framework": "FastAPI",
        "database": "PostgreSQL with SQLAlchemy",
        "storage": "Local storage backend"
      }
    }
  },
  "project_context": {
    "architecture_patterns": [
      "Clean Architecture (Data/Domain/Presentation layers)",
      "Repository Pattern (NotesRepository)",
      "Provider Pattern (Riverpod state management)",
      "Service Layer (NoteService for business logic)",
      "Cache-first strategy (offline-first UX)"
    ],
    "coding_conventions": {
      "naming": {
        "files": "snake_case.dart",
        "classes": "PascalCase",
        "functions": "camelCase",
        "variables": "camelCase",
        "providers": "camelCaseProvider"
      },
      "state_management": {
        "pattern": "Riverpod StateNotifier",
        "state_classes": "Immutable state classes with copyWith()",
        "provider_types": "StateNotifierProvider, FutureProvider, Provider"
      },
      "error_handling": {
        "pattern": "Try-catch with state error field",
        "offline_mode": "Fallback to cache on network errors",
        "user_feedback": "SnackBar for success/error messages"
      },
      "data_flow": {
        "pattern": "API -> Repository -> Provider -> UI",
        "caching": "Local Hive cache with cache-first strategy",
        "sync": "Background silent refresh after showing cache"
      }
    },
    "current_implementation": {
      "note_viewing": {
        "description": "笔记详情页当前仅支持查看，使用 LatexMarkdown widget 渲染 markdownContent",
        "file": "lib/presentation/pages/notes/note_detail_page.dart",
        "rendering": "LatexMarkdown(data: note.markdownContent, selectable: true)",
        "features": [
          "Markdown with LaTeX support",
          "Image viewer with Hero animation",
          "Category and tags display",
          "Favorite toggle",
          "Share functionality"
        ]
      },
      "note_editing": {
        "description": "当前仅支持编辑标题、分类和标签，无法编辑正文内容",
        "file": "lib/presentation/pages/notes/note_edit_page.dart",
        "editable_fields": [
          "title (TextFormField)",
          "category (ChoiceChip selection)",
          "tags (TextField with add/remove)"
        ],
        "missing": "正文内容编辑功能完全缺失"
      },
      "data_model": {
        "description": "笔记数据包含 structured_data 和 original_text 两种内容表示",
        "fields": {
          "original_text": "原始OCR识别文本",
          "structured_data": "AI生成的结构化内容 (summary, key_points, sections, study_advice)",
          "markdownContent": "从 structured_data 构建的 Markdown 内容 (getter)"
        },
        "content_generation": "通过 markdownContent getter 将 structured_data 转换为 Markdown"
      },
      "backend_support": {
        "update_endpoint": "PUT /api/v1/library/notes/{id}",
        "updateable_fields": [
          "title",
          "category",
          "tags",
          "original_text",
          "structured_data"
        ],
        "note": "后端 NoteUpdate schema 已支持 original_text 和 structured_data 更新"
      }
    }
  },
  "assets": {
    "documentation": [],
    "source_code": [
      {
        "path": "lib/presentation/pages/notes/note_detail_page.dart",
        "role": "note-viewing-ui",
        "scope": "frontend-presentation",
        "description": "笔记详情查看页面，当前使用 LatexMarkdown 组件渲染只读内容",
        "key_features": [
          "LatexMarkdown rendering",
          "Image viewer with Hero animation",
          "Favorite toggle",
          "Share and edit navigation"
        ],
        "dependencies": [
          "LatexMarkdown widget",
          "noteDetailProvider",
          "CachedNetworkImage"
        ],
        "relevance_score": 0.99,
        "modification_needed": "将只读视图改造为可编辑模式，或新增编辑模式切换"
      },
      {
        "path": "lib/presentation/pages/notes/note_edit_page.dart",
        "role": "note-editing-ui",
        "scope": "frontend-presentation",
        "description": "笔记编辑页面，当前仅支持标题、分类、标签编辑",
        "key_features": [
          "Title editing (TextFormField)",
          "Category selection (ChoiceChip)",
          "Tags management (TextField + Chip)"
        ],
        "dependencies": [
          "noteDetailProvider.updateNote()",
          "notesListProvider.updateNoteInList()"
        ],
        "relevance_score": 0.98,
        "modification_needed": "新增正文内容编辑功能（富文本编辑器集成）"
      },
      {
        "path": "lib/presentation/widgets/latex_markdown.dart",
        "role": "markdown-renderer",
        "scope": "frontend-widget",
        "description": "支持 LaTeX 公式的 Markdown 渲染器，用于笔记内容显示",
        "key_features": [
          "Block and inline LaTeX support ($$...$$, $...$)",
          "flutter_markdown + flutter_math_fork integration",
          "Selectable text support"
        ],
        "dependencies": [
          "flutter_markdown",
          "flutter_math_fork"
        ],
        "relevance_score": 0.95,
        "modification_needed": "可能需要替换为支持编辑的富文本编辑器（如 flutter_quill 或 super_editor）"
      },
      {
        "path": "lib/data/models/note_model.dart",
        "role": "data-model",
        "scope": "frontend-data",
        "description": "笔记数据模型，包含 structured_data 和 original_text",
        "key_fields": {
          "id": "笔记ID",
          "title": "标题",
          "category": "分类",
          "tags": "标签列表",
          "original_text": "原始OCR文本",
          "structured_data": "AI生成的结构化内容 (summary, key_points, sections, study_advice)",
          "markdownContent": "从 structured_data 构建的 Markdown (getter)"
        },
        "relevance_score": 0.97,
        "modification_needed": "可能需要新增编辑状态字段或修改内容更新逻辑"
      },
      {
        "path": "lib/providers/notes_provider.dart",
        "role": "state-management",
        "scope": "frontend-providers",
        "description": "笔记状态管理，包含列表和详情 provider",
        "key_providers": {
          "notesListProvider": "笔记列表状态管理 (NotesListNotifier)",
          "noteDetailProvider": "笔记详情状态管理 (NoteDetailNotifier)",
          "categoriesProvider": "分类列表 (FutureProvider)"
        },
        "key_methods": {
          "updateNote": "更新笔记（title, category, tags, originalText, structuredData）",
          "updateNoteInList": "同步更新列表中的笔记",
          "toggleFavorite": "切换收藏状态"
        },
        "relevance_score": 0.96,
        "modification_needed": "可能需要新增编辑模式状态管理和内容同步逻辑"
      },
      {
        "path": "lib/data/repositories/notes_repository.dart",
        "role": "data-layer",
        "scope": "frontend-data",
        "description": "笔记数据仓库，封装 API 调用和缓存逻辑",
        "key_methods": {
          "getNotes": "获取笔记列表（带分页和筛选）",
          "getNoteDetail": "获取笔记详情",
          "updateNote": "更新笔记（调用 NotesApi.updateNote）",
          "getCachedNotes": "获取缓存笔记",
          "addNoteToCache": "添加笔记到缓存"
        },
        "relevance_score": 0.93,
        "modification_needed": "确认 updateNote 方法支持 originalText 和 structuredData 更新"
      },
      {
        "path": "lib/data/datasources/notes_api.dart",
        "role": "api-client",
        "scope": "frontend-data",
        "description": "笔记 API 数据源，封装 HTTP 请求",
        "key_methods": {
          "getNotes": "GET /api/v1/library/notes",
          "getNoteDetail": "GET /api/v1/library/notes/{id}",
          "updateNote": "PUT /api/v1/library/notes/{id} (NoteUpdateRequest)",
          "deleteNote": "DELETE /api/v1/library/notes/{id}",
          "toggleFavorite": "POST /api/v1/library/notes/{id}/favorite"
        },
        "relevance_score": 0.92,
        "modification_needed": "验证 NoteUpdateRequest 是否支持 structured_data 字段"
      },
      {
        "path": "app/api/v1/endpoints/library.py",
        "role": "backend-api",
        "scope": "backend-endpoints",
        "description": "后端笔记 API 端点（library 路由）",
        "key_endpoints": {
          "POST /notes/from-image": "上传图片异步生成笔记",
          "POST /text/from-image": "提取图片文本（无笔记创建）"
        },
        "note": "笔记 CRUD 端点可能在其他文件中（需要查找 GET/PUT /notes/{id}）",
        "relevance_score": 0.85,
        "modification_needed": "需要确认 PUT /notes/{id} 端点位置和实现"
      },
      {
        "path": "app/schemas/note.py",
        "role": "backend-schema",
        "scope": "backend-schemas",
        "description": "后端笔记数据 schema",
        "key_schemas": {
          "NoteBase": "基础字段 (title, category, tags)",
          "NoteCreate": "创建笔记 (+ image_url, original_text, structured_data)",
          "NoteUpdate": "更新笔记 (title, category, tags, is_favorite, original_text, structured_data)",
          "NoteResponse": "笔记响应（完整字段）"
        },
        "relevance_score": 0.94,
        "modification_needed": "NoteUpdate 已支持 original_text 和 structured_data，无需修改"
      },
      {
        "path": "app/models/note.py",
        "role": "backend-model",
        "scope": "backend-models",
        "description": "后端笔记数据库模型",
        "key_fields": {
          "id": "UUID",
          "title": "标题",
          "category": "分类",
          "tags": "JSON 标签列表",
          "original_text": "Text 原始文本",
          "structured_data": "JSON 结构化数据"
        },
        "relevance_score": 0.93,
        "modification_needed": "模型字段已满足需求，无需修改"
      },
      {
        "path": "app/services/note_service.py",
        "role": "backend-service",
        "scope": "backend-services",
        "description": "后端笔记业务逻辑服务",
        "key_methods": {
          "create_note": "创建笔记",
          "get_user_notes": "获取用户笔记列表",
          "get_note_by_id": "根据ID获取笔记",
          "update_note": "更新笔记（接受 update_data 字典）",
          "delete_note": "删除笔记",
          "toggle_favorite": "切换收藏状态"
        },
        "relevance_score": 0.91,
        "modification_needed": "update_note 方法已支持任意字段更新，无需修改"
      }
    ],
    "config": [
      {
        "path": "pubspec.yaml",
        "scope": "frontend-config",
        "description": "Flutter 依赖配置文件",
        "current_editor_deps": {
          "flutter_markdown": "0.7.4+3 (只读渲染)",
          "flutter_math_fork": "0.7.2 (LaTeX 支持)"
        },
        "missing_deps": [
          "flutter_quill (富文本编辑器)",
          "super_editor (高级编辑器)"
        ],
        "relevance_score": 0.88,
        "modification_needed": "需要添加富文本编辑器依赖（flutter_quill 或 super_editor）"
      }
    ],
    "tests": []
  },
  "dependencies": {
    "internal": [
      {
        "from": "lib/presentation/pages/notes/note_detail_page.dart",
        "to": "lib/presentation/widgets/latex_markdown.dart",
        "type": "widget-dependency",
        "description": "详情页使用 LatexMarkdown 渲染笔记内容"
      },
      {
        "from": "lib/presentation/pages/notes/note_detail_page.dart",
        "to": "lib/providers/notes_provider.dart",
        "type": "state-dependency",
        "description": "详情页依赖 noteDetailProvider 和 notesListProvider"
      },
      {
        "from": "lib/presentation/pages/notes/note_edit_page.dart",
        "to": "lib/providers/notes_provider.dart",
        "type": "state-dependency",
        "description": "编辑页依赖 noteDetailProvider.updateNote()"
      },
      {
        "from": "lib/providers/notes_provider.dart",
        "to": "lib/data/repositories/notes_repository.dart",
        "type": "data-dependency",
        "description": "Provider 调用 Repository 进行数据操作"
      },
      {
        "from": "lib/data/repositories/notes_repository.dart",
        "to": "lib/data/datasources/notes_api.dart",
        "type": "api-dependency",
        "description": "Repository 调用 API 数据源"
      },
      {
        "from": "lib/data/datasources/notes_api.dart",
        "to": "app/api/v1/endpoints/library.py",
        "type": "http-dependency",
        "description": "前端 API 调用后端 REST 端点"
      },
      {
        "from": "app/api/v1/endpoints/library.py",
        "to": "app/services/note_service.py",
        "type": "service-dependency",
        "description": "API 端点调用业务逻辑服务"
      },
      {
        "from": "app/services/note_service.py",
        "to": "app/models/note.py",
        "type": "model-dependency",
        "description": "服务层操作数据库模型"
      }
    ],
    "external": [
      {
        "package": "flutter_markdown",
        "version": "^0.7.4+3",
        "usage": "Markdown 渲染（只读）",
        "platform": "frontend"
      },
      {
        "package": "flutter_math_fork",
        "version": "^0.7.2",
        "usage": "LaTeX 公式渲染",
        "platform": "frontend"
      },
      {
        "package": "flutter_riverpod",
        "version": "^2.6.1",
        "usage": "状态管理",
        "platform": "frontend"
      },
      {
        "package": "go_router",
        "version": "^14.6.2",
        "usage": "路由导航",
        "platform": "frontend"
      },
      {
        "package": "dio",
        "version": "^5.7.0",
        "usage": "HTTP 请求",
        "platform": "frontend"
      },
      {
        "package": "flutter_quill (待添加)",
        "version": "推荐最新版本",
        "usage": "富文本编辑器（推荐方案1）",
        "platform": "frontend",
        "note": "高人气，193个代码示例，支持 WYSIWYG 编辑"
      },
      {
        "package": "super_editor (待添加)",
        "version": "推荐最新版本",
        "usage": "高级文档编辑器（推荐方案2）",
        "platform": "frontend",
        "note": "496个代码示例，可配置性强，适合复杂编辑需求"
      }
    ]
  },
  "conflict_detection": {
    "risk_level": "medium",
    "risk_factors": {
      "existing_implementations": [
        "lib/presentation/pages/notes/note_detail_page.dart (需要大幅改造)",
        "lib/presentation/pages/notes/note_edit_page.dart (需要扩展)",
        "lib/presentation/widgets/latex_markdown.dart (可能需要替换或共存)"
      ],
      "architecture_changes": false,
      "api_changes": false,
      "data_model_changes": false,
      "breaking_changes": [
        "note_detail_page.dart 从纯查看模式改为可编辑模式（用户体验变化）",
        "可能需要引入编辑/预览模式切换（UI 交互变化）",
        "LatexMarkdown widget 可能被编辑器组件替换（渲染方式变化）"
      ],
      "integration_risks": [
        "flutter_quill 或 super_editor 与现有 LaTeX 支持的兼容性",
        "富文本编辑器内容与 structured_data 格式的转换",
        "编辑器性能（大文档、复杂格式）",
        "编辑器与 Markdown/LaTeX 的双向转换"
      ]
    },
    "affected_modules": [
      "lib/presentation/pages/notes/note_detail_page.dart",
      "lib/presentation/pages/notes/note_edit_page.dart",
      "lib/presentation/widgets/latex_markdown.dart",
      "lib/providers/notes_provider.dart",
      "lib/data/repositories/notes_repository.dart"
    ],
    "mitigation_strategy": "增量实现策略：(1) 先添加基础富文本编辑功能（不破坏现有查看功能），(2) 实现编辑/预览模式切换，(3) 集成 LaTeX 支持，(4) 实现内容格式转换，(5) 性能优化和测试。保持向后兼容，现有查看功能不受影响。",
    "implementation_approach": {
      "phase_1": "环境准备：添加 flutter_quill 或 super_editor 依赖到 pubspec.yaml",
      "phase_2": "基础集成：创建新的 NoteContentEditor widget，支持基本编辑功能",
      "phase_3": "UI 改造：在 note_edit_page.dart 中集成编辑器 widget，添加内容编辑字段",
      "phase_4": "状态管理：扩展 noteDetailProvider.updateNote() 支持内容更新",
      "phase_5": "数据转换：实现编辑器内容与 structured_data/original_text 的转换逻辑",
      "phase_6": "LaTeX 支持：集成 LaTeX 编辑功能（根据编辑器能力）",
      "phase_7": "预览模式：实现编辑/预览切换（可选在 note_detail_page 中）",
      "phase_8": "测试优化：性能测试、用户体验优化、边界情况处理"
    }
  },
  "recommended_libraries": {
    "option_1": {
      "name": "flutter_quill",
      "library_id": "/singerdmx/flutter-quill",
      "pros": [
        "WYSIWYG 编辑体验",
        "193 个代码示例（高文档覆盖）",
        "支持 Android, iOS, Web, Desktop",
        "Rich text formatting (bold, italic, lists, etc.)",
        "High source reputation",
        "社区活跃，更新频繁"
      ],
      "cons": [
        "LaTeX 支持需要额外插件或自定义",
        "可能需要学习 Quill Delta 格式",
        "与现有 structured_data 格式转换较复杂"
      ],
      "use_case": "适合需要类似 Notion 的富文本编辑体验，格式化功能丰富"
    },
    "option_2": {
      "name": "super_editor",
      "library_id": "/superlistapp/super_editor",
      "pros": [
        "496 个代码示例（最高文档覆盖）",
        "可配置性和可扩展性强",
        "支持任何后端",
        "High source reputation",
        "更灵活的文档结构",
        "适合构建复杂编辑器"
      ],
      "cons": [
        "学习曲线较陡",
        "配置复杂度高",
        "可能需要更多自定义代码"
      ],
      "use_case": "适合需要高度定制的编辑体验，类似 Obsidian 的编辑器"
    },
    "recommendation": "建议优先尝试 flutter_quill，因为：(1) 更快的开发速度，(2) 开箱即用的 WYSIWYG 体验，(3) 社区支持好。如果需要更高的定制化（如完全自定义块类型、复杂渲染逻辑），则考虑 super_editor。"
  },
  "technical_considerations": {
    "content_format_conversion": {
      "challenge": "编辑器内容格式与现有 structured_data/original_text 的转换",
      "solutions": [
        "方案1：使用 original_text 存储 Markdown 原始文本，编辑器直接编辑 Markdown",
        "方案2：使用 structured_data 存储编辑器 Delta/JSON 格式，渲染时转换为 Markdown",
        "方案3：双格式存储（保留 structured_data 用于只读渲染，新增 editor_content 用于编辑）"
      ],
      "recommendation": "方案1最简单，直接编辑 Markdown 文本，与现有 markdownContent getter 兼容"
    },
    "latex_support": {
      "challenge": "富文本编辑器中支持 LaTeX 公式编辑",
      "solutions": [
        "方案1：flutter_quill + flutter_quill_extensions (可能支持 LaTeX)",
        "方案2：自定义 Quill Embed 处理 LaTeX 块",
        "方案3：编辑模式使用纯文本，预览模式使用 LatexMarkdown"
      ],
      "recommendation": "方案3最稳妥，编辑器专注文本编辑，预览时使用现有 LatexMarkdown 渲染"
    },
    "performance": {
      "challenge": "大文档编辑性能",
      "solutions": [
        "使用虚拟滚动（编辑器内置）",
        "延迟保存（debounce save）",
        "差量更新（只传输变更部分）"
      ]
    },
    "offline_editing": {
      "challenge": "离线编辑和同步",
      "solutions": [
        "本地缓存编辑内容",
        "后台同步队列",
        "冲突检测和解决"
      ],
      "note": "现有 cache-first 策略可直接应用于编辑场景"
    }
  }
}
