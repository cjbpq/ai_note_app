{
  "metadata": {
    "task_description": "对 backend 进行系统化的优化重构，识别主要问题并修复，为后端新手提供带注释的改进说明",
    "timestamp": "2025-11-18T00:00:00Z",
    "keywords": [
      "refactoring",
      "code quality",
      "architecture",
      "error handling",
      "async patterns",
      "database",
      "API design",
      "security",
      "testing",
      "FastAPI"
    ],
    "complexity": "complex",
    "tech_stack": {
      "language": "python",
      "framework": "FastAPI",
      "database": "SQLAlchemy + SQLite",
      "testing": "pytest",
      "migration": "alembic",
      "AI_service": "Doubao Vision API"
    },
    "session_id": "WFS-backend-refactor"
  },
  "project_context": {
    "architecture_patterns": [
      "REST API",
      "Service Layer Pattern",
      "Repository Pattern (partial)",
      "Async/Await Pattern",
      "Background Task Processing"
    ],
    "coding_conventions": {
      "naming": {
        "functions": "snake_case",
        "classes": "PascalCase",
        "constants": "UPPER_SNAKE_CASE"
      },
      "error_handling": {
        "pattern": "HTTPException with status codes",
        "issues": "不一致的错误处理，部分使用泛型 Exception"
      },
      "async_patterns": {
        "preferred": "async/await",
        "issues": "混合使用同步和异步代码，asyncio.create_task 无异常追踪"
      }
    },
    "tech_stack": {
      "language": "python",
      "frameworks": [
        "FastAPI==0.104.1",
        "uvicorn==0.24.0"
      ],
      "libraries": [
        "sqlalchemy",
        "pydantic==2.7.1",
        "pydantic-settings==2.4.0",
        "pyjwt==2.8.0",
        "bcrypt==4.1.2",
        "volcengine-python-sdk[ark]==1.0.101"
      ],
      "database": "SQLite (via SQLAlchemy)",
      "migration": "alembic",
      "testing": "pytest==7.4.3"
    }
  },
  "assets": {
    "documentation": [],
    "source_code": [
      {
        "path": "app/main.py",
        "role": "application-entry",
        "dependencies": [
          "app.api.v1.api",
          "app.api.admin.router",
          "app.api.admin.ui",
          "app.core.config",
          "app.database"
        ],
        "exports": [
          "app"
        ],
        "issues": [
          "使用已弃用的 @app.on_event('startup')，应改用 lifespan",
          "CORS 配置过于宽松 (allow_origins=['*'])",
          "uvicorn stdin 补丁逻辑复杂且难以维护"
        ],
        "relevance_score": 0.99
      },
      {
        "path": "app/database.py",
        "role": "database-config",
        "exports": [
          "engine",
          "SessionLocal",
          "Base",
          "get_db",
          "ensure_sqlite_schema"
        ],
        "issues": [
          "ensure_sqlite_schema 硬编码 SQLite 特定逻辑，不通用",
          "缺少连接池配置",
          "无数据库健康检查机制"
        ],
        "relevance_score": 0.95
      },
      {
        "path": "app/core/config.py",
        "role": "configuration",
        "exports": [
          "Settings",
          "settings"
        ],
        "issues": [
          "SECRET_KEY 默认值不安全",
          "配置验证逻辑复杂 (_apply_doubao_alias_fallbacks)",
          "缺少环境区分 (dev/staging/prod)"
        ],
        "relevance_score": 0.94
      },
      {
        "path": "app/core/security.py",
        "role": "security",
        "exports": [
          "create_access_token",
          "verify_password",
          "get_password_hash",
          "verify_token"
        ],
        "issues": [
          "使用已弃用的 datetime.utcnow()，应用 timezone-aware datetime",
          "bcrypt 编解码逻辑冗余",
          "异常处理过于宽泛 (except jwt.PyJWTError)"
        ],
        "relevance_score": 0.93
      },
      {
        "path": "app/core/dependencies.py",
        "role": "dependency-injection",
        "exports": [
          "get_current_user"
        ],
        "issues": [
          "重复的 HTTPException 实例化",
          "缺少日志记录",
          "错误信息不够详细"
        ],
        "relevance_score": 0.90
      },
      {
        "path": "app/api/v1/endpoints/library.py",
        "role": "api-endpoint",
        "dependencies": [
          "app.services.note_service.NoteService",
          "app.services.doubao_service.doubao_service",
          "app.services.input_pipeline_service.InputPipelineService",
          "app.services.export_service.ExportService"
        ],
        "issues": [
          "asyncio.create_task 无异常追踪，后台任务失败不可见",
          "重复的 doubao 可用性检查代码",
          "update_note 中的 dict() 调用已弃用，应用 model_dump()",
          "异常处理不一致 (BLE001 noqa 标记)",
          "favorite_only 过滤在内存中而非数据库查询"
        ],
        "relevance_score": 0.98
      },
      {
        "path": "app/services/note_service.py",
        "role": "service-layer",
        "exports": [
          "NoteService"
        ],
        "issues": [
          "缺少日志记录",
          "缺少事务管理和回滚逻辑",
          "search_notes 的 LIKE 查询存在 SQL 注入风险",
          "缺少分页参数验证"
        ],
        "relevance_score": 0.96
      },
      {
        "path": "app/services/doubao_service.py",
        "role": "external-service",
        "exports": [
          "DoubaoVisionService",
          "doubao_service",
          "DoubaoServiceError"
        ],
        "issues": [
          "泛型异常捕获 (except Exception)",
          "缺少重试机制",
          "缺少请求/响应日志",
          "单例模式实现不够明确"
        ],
        "relevance_score": 0.94
      },
      {
        "path": "app/services/upload_service.py",
        "role": "file-handling",
        "exports": [
          "save_upload_file",
          "get_file_by_id"
        ],
        "issues": [
          "全局变量定义不规范 (UPLOAD_DIR, ALLOWED_EXTENSIONS)",
          "get_file_by_id 使用文件系统遍历而非数据库查询",
          "缺少文件大小验证",
          "异常处理不够细致",
          "缺少并发访问保护"
        ],
        "relevance_score": 0.88
      },
      {
        "path": "app/models/note.py",
        "role": "data-model",
        "exports": [
          "Note"
        ],
        "issues": [
          "user_id 可为空但有外键约束，逻辑不清晰",
          "缺少索引优化 (category, is_favorite)",
          "to_dict 方法与 Pydantic schema 重复"
        ],
        "relevance_score": 0.92
      },
      {
        "path": "app/api/v1/endpoints/notes.py",
        "role": "deprecated-endpoint",
        "exports": [
          "deprecated endpoints"
        ],
        "issues": [
          "废弃端点应该移除或添加 deprecated=True 标记",
          "占用路由空间"
        ],
        "relevance_score": 0.70
      },
      {
        "path": "app/api/v1/endpoints/ocr.py",
        "role": "deprecated-endpoint",
        "exports": [
          "deprecated endpoints"
        ],
        "issues": [
          "废弃端点应该移除或添加 deprecated=True 标记"
        ],
        "relevance_score": 0.70
      }
    ],
    "config": [
      {
        "path": "requirements.txt",
        "relevance_score": 0.85
      },
      {
        "path": ".env",
        "issues": [
          "SECRET_KEY 为空，存在安全风险",
          "API keys 应移至 secrets 管理系统"
        ],
        "relevance_score": 0.90
      },
      {
        "path": "alembic.ini",
        "relevance_score": 0.75
      }
    ],
    "tests": [
      {
        "path": "tests/test_auth_account.py",
        "relevance_score": 0.85
      },
      {
        "path": "tests/test_input_pipeline.py",
        "relevance_score": 0.85
      },
      {
        "path": "tests/test_async_pipeline.py",
        "relevance_score": 0.85
      },
      {
        "path": "tests/test_prompt_profiles.py",
        "relevance_score": 0.80
      }
    ]
  },
  "dependencies": {
    "internal": [
      {
        "from": "app/main.py",
        "to": "app/database.py",
        "type": "initialization"
      },
      {
        "from": "app/api/v1/endpoints/library.py",
        "to": "app/services/note_service.py",
        "type": "service-dependency"
      },
      {
        "from": "app/api/v1/endpoints/library.py",
        "to": "app/services/doubao_service.py",
        "type": "service-dependency"
      },
      {
        "from": "app/services/note_service.py",
        "to": "app/models/note.py",
        "type": "model-dependency"
      },
      {
        "from": "app/core/dependencies.py",
        "to": "app/core/security.py",
        "type": "authentication"
      },
      {
        "from": "app/core/dependencies.py",
        "to": "app/services/user_service.py",
        "type": "service-dependency"
      }
    ],
    "external": [
      {
        "package": "fastapi",
        "version": "0.104.1",
        "usage": "Web framework"
      },
      {
        "package": "sqlalchemy",
        "version": "latest",
        "usage": "ORM and database operations"
      },
      {
        "package": "pydantic",
        "version": "2.7.1",
        "usage": "Data validation and settings"
      },
      {
        "package": "pyjwt",
        "version": "2.8.0",
        "usage": "JWT token generation and verification"
      },
      {
        "package": "bcrypt",
        "version": "4.1.2",
        "usage": "Password hashing"
      },
      {
        "package": "volcengine-python-sdk",
        "version": "1.0.101",
        "usage": "Doubao AI service integration"
      },
      {
        "package": "pytest",
        "version": "7.4.3",
        "usage": "Testing framework"
      }
    ]
  },
  "brainstorm_artifacts": {
    "guidance_specification": {
      "path": ".workflow/WFS-backend-refactor/.brainstorming/guidance-specification.md",
      "exists": false,
      "content": null
    },
    "role_analyses": [],
    "synthesis_output": {
      "path": ".workflow/WFS-backend-refactor/.brainstorming/synthesis-specification.md",
      "exists": false,
      "content": null
    }
  },
  "conflict_detection": {
    "risk_level": "high",
    "risk_factors": {
      "existing_implementations": [
        "app/main.py",
        "app/database.py",
        "app/core/config.py",
        "app/core/security.py",
        "app/api/v1/endpoints/library.py",
        "app/services/note_service.py",
        "app/services/doubao_service.py",
        "app/services/upload_service.py",
        "app/models/note.py"
      ],
      "api_changes": true,
      "architecture_changes": true,
      "data_model_changes": false,
      "breaking_changes": [
        "废弃 @app.on_event 改用 lifespan 需要修改启动逻辑",
        "Pydantic v2 dict() -> model_dump() 需要全局替换",
        "datetime.utcnow() -> datetime.now(timezone.utc) 需要全局更新",
        "CORS 配置收紧可能影响前端",
        "废弃端点移除可能影响旧版本客户端"
      ]
    },
    "affected_modules": [
      "main",
      "database",
      "core",
      "api/v1/endpoints",
      "services",
      "models"
    ],
    "mitigation_strategy": "采用增量重构策略：(1) 首先修复安全问题和配置问题；(2) 其次改进错误处理和日志；(3) 然后优化异步任务管理；(4) 最后清理废弃代码。每个阶段独立测试，确保向后兼容。"
  },
  "identified_issues": {
    "critical": [
      {
        "category": "security",
        "issue": "SECRET_KEY 默认值不安全且 .env 中为空",
        "location": "app/core/config.py, .env",
        "impact": "JWT 令牌可被伪造，严重安全隐患",
        "solution": "生成强随机密钥并在部署时通过环境变量注入"
      },
      {
        "category": "security",
        "issue": "CORS 配置过于宽松 (allow_origins=['*'])",
        "location": "app/main.py",
        "impact": "允许任意域名访问，存在 CSRF 风险",
        "solution": "限制为前端域名白名单"
      },
      {
        "category": "async",
        "issue": "asyncio.create_task 无异常追踪",
        "location": "app/api/v1/endpoints/library.py:97",
        "impact": "后台任务失败不可见，用户得不到反馈",
        "solution": "使用 BackgroundTasks 或添加异常处理回调"
      }
    ],
    "high": [
      {
        "category": "deprecated-api",
        "issue": "使用已弃用的 @app.on_event('startup')",
        "location": "app/main.py:85",
        "impact": "FastAPI 未来版本将移除此 API",
        "solution": "迁移到 lifespan context manager"
      },
      {
        "category": "deprecated-api",
        "issue": "使用已弃用的 datetime.utcnow()",
        "location": "app/core/security.py:11,13",
        "impact": "Python 未来版本可能移除",
        "solution": "使用 datetime.now(timezone.utc)"
      },
      {
        "category": "deprecated-api",
        "issue": "Pydantic v2 中 dict() 已弃用",
        "location": "app/api/v1/endpoints/library.py:264",
        "impact": "未来版本将移除",
        "solution": "使用 model_dump()"
      },
      {
        "category": "error-handling",
        "issue": "泛型异常捕获 (except Exception)",
        "location": "app/services/doubao_service.py:126,184,205",
        "impact": "隐藏真实错误，难以调试",
        "solution": "捕获具体异常类型并记录详细信息"
      },
      {
        "category": "database",
        "issue": "search_notes 的 LIKE 查询存在 SQL 注入风险",
        "location": "app/services/note_service.py:99",
        "impact": "潜在的安全漏洞",
        "solution": "使用参数化查询确保安全"
      }
    ],
    "medium": [
      {
        "category": "code-quality",
        "issue": "缺少日志记录",
        "location": "app/services/note_service.py, app/core/dependencies.py",
        "impact": "难以追踪问题和性能分析",
        "solution": "添加结构化日志记录 (logging)"
      },
      {
        "category": "code-quality",
        "issue": "重复的代码逻辑",
        "location": "app/api/v1/endpoints/library.py (doubao 可用性检查)",
        "impact": "维护成本高",
        "solution": "抽取为装饰器或中间件"
      },
      {
        "category": "performance",
        "issue": "favorite_only 过滤在内存中而非数据库",
        "location": "app/api/v1/endpoints/library.py:222",
        "impact": "性能低下，浪费数据库资源",
        "solution": "在 SQL 查询中添加过滤条件"
      },
      {
        "category": "architecture",
        "issue": "get_file_by_id 使用文件系统遍历",
        "location": "app/services/upload_service.py:49",
        "impact": "性能差且不可靠",
        "solution": "使用数据库索引查询"
      },
      {
        "category": "code-quality",
        "issue": "缺少事务管理和回滚逻辑",
        "location": "app/services/note_service.py",
        "impact": "数据不一致风险",
        "solution": "添加事务上下文管理器"
      }
    ],
    "low": [
      {
        "category": "maintenance",
        "issue": "废弃端点应该移除或标记",
        "location": "app/api/v1/endpoints/notes.py, app/api/v1/endpoints/ocr.py",
        "impact": "占用路由空间，混淆 API 文档",
        "solution": "添加 deprecated=True 或完全移除"
      },
      {
        "category": "optimization",
        "issue": "缺少数据库索引优化",
        "location": "app/models/note.py",
        "impact": "查询性能不佳",
        "solution": "为 category, is_favorite 等字段添加索引"
      },
      {
        "category": "code-quality",
        "issue": "user_id 可为空但有外键约束",
        "location": "app/models/note.py:17",
        "impact": "逻辑不清晰，容易引起混淆",
        "solution": "明确业务逻辑，统一数据模型"
      }
    ]
  }
}
