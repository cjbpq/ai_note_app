{
  "id": "IMPL-002",
  "title": "已弃用 API 迁移和架构改进 (P1)",
  "status": "completed",
  "meta": {
    "type": "refactor",
    "agent": "@code-developer",
    "priority": "P1",
    "estimated_complexity": "medium"
  },
  "context": {
    "requirements": [
      "迁移 3 个已弃用 API: [Pydantic v2 .dict() → .model_dump() (library.py:264), datetime.utcnow() → datetime.now(timezone.utc) (security.py:11,13), @app.on_event() → lifespan (main.py:85-88)]",
      "修改 3 个核心文件: [app/api/v1/endpoints/library.py, app/core/security.py, app/main.py]",
      "新增 1 个 lifespan context manager",
      "新增 4 个测试用例验证迁移: [model_dump 兼容性, timezone-aware datetime, lifespan 执行顺序, Token 时区一致性]"
    ],
    "focus_paths": [
      "app/api/v1/endpoints/library.py",
      "app/core/security.py",
      "app/main.py"
    ],
    "acceptance": [
      "3 个已���用 API 已迁移: 验证 grep -r 'dict()' app/ | grep -v model_dump 无结果",
      "所有 datetime 使用 timezone-aware: 验证 grep -r 'utcnow()' app/ 无结果",
      "lifespan 替换 @app.on_event: 验证 grep -r '@app.on_event' app/main.py 无结果",
      "新增 4 个测试用例通过: 验证 pytest tests/integration/test_api_migration.py -v 退出码 0"
    ],
    "depends_on": ["IMPL-001"],
    "artifacts": [
      {
        "type": "synthesis_specification",
        "path": ".workflow/WFS-backend-refactor/.brainstorming/guidance-specification.md",
        "priority": "highest",
        "relevant_sections": ["API 迁移策略", "架构模式改进"]
      },
      {
        "type": "role_analysis",
        "path": ".workflow/WFS-backend-refactor/.brainstorming/subject-matter-expert/analysis.md",
        "priority": "high",
        "relevant_sections": ["Pydantic v2 迁移", "时间处理标准化", "生命周期管理"]
      },
      {
        "type": "role_analysis",
        "path": ".workflow/WFS-backend-refactor/.brainstorming/system-architect/analysis.md",
        "priority": "high",
        "relevant_sections": ["架构模式", "依赖注入"]
      }
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_migration_guide",
        "description": "加载 Pydantic v2 和 FastAPI 生命周期迁移指南",
        "commands": [
          "Read(.workflow/WFS-backend-refactor/.brainstorming/subject-matter-expert/analysis.md)",
          "mcp__context7__resolve-library-id(libraryName='pydantic')",
          "mcp__context7__get-library-docs(context7CompatibleLibraryID='/websites/pydantic_dev', topic='migration v1 to v2', page=1)"
        ],
        "output_to": "migration_guide",
        "on_error": "continue_optional"
      },
      {
        "step": "locate_deprecated_apis",
        "description": "定位所有已弃用 API 使用位置",
        "commands": [
          "Grep(pattern='\\.dict\\(', path='app/', output_mode='content', -n=true)",
          "Grep(pattern='datetime\\.utcnow\\(\\)', path='app/', output_mode='content', -n=true)",
          "Grep(pattern='@app\\.on_event', path='app/', output_mode='content', -n=true)"
        ],
        "output_to": "deprecated_api_locations",
        "on_error": "fail_task"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "Pydantic v2 迁移: .dict() → .model_dump()",
        "description": "全局替换 Pydantic 模型的 .dict() 方法为 .model_dump()",
        "modification_points": [
          "修改 app/api/v1/endpoints/library.py 第 264 行: note_update.dict(exclude_unset=True) → note_update.model_dump(exclude_unset=True)",
          "扫描并修改所有其他 .dict() 调用 (预计 2-3 处)",
          "新增 tests/integration/test_pydantic_v2_migration.py (2 个测试用例): [test_model_dump_excludes_unset_fields(), test_model_dump_json_compatibility()]"
        ],
        "logic_flow": [
          "读取 subject-matter-expert/analysis.md 第 186-212 行 (Pydantic v2 迁移映射表)",
          "使用 Grep 定位所有 .dict() 调用位置 (排除第三方库)",
          "逐个替换为 .model_dump(), 保留原有参数 (exclude_unset, exclude_none)",
          "编写 2 个测试用例验证迁移: exclude_unset 行为一致性 + JSON 序列化兼容性",
          "新增学习注释: 说明 Pydantic v2 为什么重命名 (更清晰的 API 命名)"
        ],
        "depends_on": [],
        "output": "pydantic_v2_migrated",
        "学习要点": [
          "Pydantic v2 性能提升: 使用 Rust 实现核心验证逻辑, 速度提升 5-10 倍",
          "API 重命名原因: model_dump 比 dict 更明确表达 '序列化模型为字���' 的语义",
          "向后兼容性: Pydantic v2 仍支持 .dict() 但会发出 DeprecationWarning"
        ]
      },
      {
        "step": 2,
        "title": "时间处理标准化: datetime.utcnow() → datetime.now(timezone.utc)",
        "description": "将所有 datetime.utcnow() 替换为 timezone-aware 时间",
        "modification_points": [
          "修改 app/core/security.py 第 11 行: expire = datetime.now(timezone.utc) + expires_delta",
          "修改 app/core/security.py 第 13 行: expire = datetime.now(timezone.utc) + timedelta(...)",
          "新增 security.py 导入: from datetime import timezone",
          "扫描并修改所有其他 datetime.utcnow() 调用 (预计 0-2 处)",
          "新增 tests/security/test_timezone_aware_datetime.py (2 个测试用例): [test_jwt_exp_is_timezone_aware(), test_token_expiration_across_timezones()]"
        ],
        "logic_flow": [
          "读取 subject-matter-expert/analysis.md 第 215-265 行 (时间处理最佳实践)",
          "使用 Grep 定位所有 datetime.utcnow() 调用位置",
          "替换为 datetime.now(timezone.utc) (2 处修改)",
          "新增 timezone 导入 (1 处导入)",
          "编写 2 个测试用例验证: JWT exp 字段是 timezone-aware + 跨时区 Token 验证",
          "新增学习注释: 说明 timezone-aware datetime 的重要性 (防止时区转换错误)"
        ],
        "depends_on": [1],
        "output": "timezone_migrated",
        "学习要点": [
          "Naive vs Aware datetime: datetime.utcnow() 返回 naive datetime (无时区信息), 可能导致时区转换错误",
          "Python 3.12+ 弃用: datetime.utcnow() 将在 Python 3.12+ 被移除",
          "JWT 时区处理: PyJWT 的 exp 字段会自动处理 Unix 时间戳, 但应用层应统一使用 UTC 时间"
        ]
      },
      {
        "step": 3,
        "title": "生命周期管理: @app.on_event() → lifespan",
        "description": "迁移到 FastAPI 0.93+ 推荐的 lifespan context manager",
        "modification_points": [
          "修改 app/main.py: 新增 lifespan() async context manager (15 行代码)",
          "移除 app/main.py 第 85-88 行: @app.on_event('startup') 装饰器和函数",
          "修改 app/main.py FastAPI 初始化: 添加 lifespan=lifespan 参数",
          "新增 from contextlib import asynccontextmanager 导入",
          "新增 tests/integration/test_lifespan.py (2 个测试用例): [test_lifespan_startup_creates_tables(), test_lifespan_shutdown_cleanup()]"
        ],
        "logic_flow": [
          "读取 subject-matter-expert/analysis.md 第 268-325 行 (生命周期管理迁移)",
          "创建 lifespan async context manager 函数",
          "将 @app.on_event('startup') 逻辑移到 yield 之前",
          "删除旧的 @app.on_event() ���饰器代码 (4 行)",
          "修改 FastAPI 构造函数传入 lifespan 参数 (1 处修改)",
          "编写 2 个测试用例验证: 启动时数据库初始化 + 关闭时资源清理",
          "新增学习注释: 说明 lifespan 模式的优势 (统一资源管理, 支持依赖注入)"
        ],
        "depends_on": [1, 2],
        "output": "lifespan_migrated",
        "学习要点": [
          "FastAPI 0.93+ 新特性: @app.on_event() 已弃用, 推荐使用 lifespan context manager",
          "lifespan 优势: 统一启动/关闭逻辑, 避免事件回调顺序问题, 支持依赖注入",
          "Context Manager 模式: yield 前执行启动逻辑, yield 后执行关闭逻辑"
        ]
      },
      {
        "step": 4,
        "title": "验证迁移和回归测试",
        "description": "运行完整测试套件验证迁移无破坏性变更",
        "modification_points": [
          "运行集成测试: pytest tests/integration/test_api_migration.py -v",
          "运行黄金文件测试: pytest tests/golden/ -v (如果已存在)",
          "运行完整测试套件: pytest tests/ -v --cov=app",
          "生成迁移报告: 列出修改的文件和新增的测试"
        ],
        "logic_flow": [
          "执行所有新增测试用例 (6 个测试)",
          "执行完整测试套件验证无回归",
          "生成迁移报告: 3 个已弃用 API 已迁移, 6 个测试用例新增"
        ],
        "depends_on": [1, 2, 3],
        "output": "migration_verification_report"
      }
    ],
    "target_files": [
      "app/api/v1/endpoints/library.py:264",
      "app/core/security.py:11,13",
      "app/main.py:lifespan,85-88",
      "tests/integration/test_pydantic_v2_migration.py",
      "tests/security/test_timezone_aware_datetime.py",
      "tests/integration/test_lifespan.py"
    ]
  }
}
