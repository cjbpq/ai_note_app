<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8" />
    <title>{{ app_name }} · Prompt 管理控制台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f6f7fb;
        --panel: #ffffffdd;
        --primary: #2563eb;
        --border: #e5e7eb;
        --danger: #dc2626;
        font-family: "Segoe UI", "PingFang SC", "Microsoft Yahei", sans-serif;
      }
      body {
        margin: 0;
        background: linear-gradient(135deg, #eef2ff, #fdf2f8);
        min-height: 100vh;
        color: #1f2937;
      }
      header {
        padding: 1.2rem 2rem;
        background: rgba(15, 23, 42, 0.9);
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.25);
      }
      header h1 {
        margin: 0;
        font-size: 1.4rem;
        letter-spacing: 0.02em;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      #login-state {
        font-size: 0.95rem;
        opacity: 0.8;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 0.65rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        color: #fff;
        box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
      }
      button.secondary {
        background: rgba(37, 99, 235, 0.1);
        color: #2563eb;
      }
      button.danger {
        background: rgba(220, 38, 38, 0.1);
        color: var(--danger);
      }
      button.compact {
        padding: 0.45rem 0.9rem;
        font-size: 0.85rem;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }
      button:not(:disabled):hover {
        transform: translateY(-1px) scale(1.01);
      }
      main {
        padding: 2rem;
        display: grid;
        gap: 1.5rem;
      }
      .glass {
        background: var(--panel);
        border-radius: 18px;
        box-shadow: 0 20px 45px rgba(79, 70, 229, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      #console {
        display: grid;
        grid-template-columns: minmax(240px, 320px) 1fr 320px;
        gap: 1.5rem;
      }
      #profile-list,
      #history-panel,
      #editor-panel,
      #guide-panel {
        padding: 1.5rem;
      }
      #profile-list {
        display: flex;
        flex-direction: column;
      }
      #profile-list h3,
      #editor-panel h3,
      #history-panel h3 {
        margin-top: 0;
      }
      .profile-item {
        padding: 0.85rem 1rem;
        margin-bottom: 0.6rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background: rgba(255, 255, 255, 0.75);
      }
      .profile-item.active {
        border-color: #6366f1;
        box-shadow: 0 10px 24px rgba(99, 102, 241, 0.25);
      }
      .profile-item small {
        display: block;
        margin-top: 0.35rem;
        color: #64748b;
        font-size: 0.82rem;
      }
      label {
        display: block;
        margin-bottom: 0.35rem;
        font-weight: 600;
      }
      input,
      textarea {
        width: 100%;
        padding: 0.75rem 0.85rem;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 0.95rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        font-family: inherit;
      }
      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      }
      textarea {
        min-height: 140px;
        resize: vertical;
        line-height: 1.5;
      }
      .field-group {
        margin-bottom: 1rem;
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin-top: 1rem;
      }
      #history-list {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      .history-item {
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 12px;
        padding: 0.85rem;
        margin-bottom: 0.6rem;
        background: rgba(255, 255, 255, 0.75);
      }
      .history-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #475569;
      }
      #guide-panel {
        background: rgba(15, 23, 42, 0.85);
        color: #e2e8f0;
        border: none;
      }
      #guide-panel h3 {
        margin-top: 0;
        color: #facc15;
      }
      #guide-panel ul {
        margin: 0 0 0 1.1rem;
        padding: 0;
      }
      #guide-panel li {
        margin-bottom: 0.65rem;
        line-height: 1.5;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        background: rgba(99, 102, 241, 0.15);
        color: #4338ca;
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .preview-panel {
        margin-top: 1.8rem;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.8);
        padding: 1.2rem 1.4rem;
      }
      .preview-actions {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
      }
      .preview-meta {
        font-size: 0.8rem;
        color: #475569;
        margin: 0.4rem 0 1rem;
      }
      .preview-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .preview-controls .field-group {
        flex: 1 1 220px;
        margin-bottom: 0;
      }
      .preview-outputs {
        display: grid;
        gap: 1rem;
      }
      .preview-box {
        background: rgba(15, 23, 42, 0.05);
        border-radius: 10px;
        padding: 0.75rem 0.85rem;
      }
      .preview-box h5 {
        margin: 0 0 0.5rem;
        font-size: 0.9rem;
        color: #1e40af;
      }
      .preview-box pre {
        margin: 0;
        max-height: 240px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 0.85rem;
        line-height: 1.5;
        font-family: "JetBrains Mono", "Cascadia Code", monospace;
      }
      .preview-empty {
        color: #94a3b8;
        font-style: italic;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 0.9rem 1.1rem;
        border-radius: 12px;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.2);
        z-index: 999;
        transition: opacity 0.3s ease;
      }
      .notification.success {
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }
      .notification.error {
        background: linear-gradient(135deg, #f97316, #dc2626);
      }
      @media (max-width: 1200px) {
        #console {
          grid-template-columns: 1fr;
        }
        #history-panel,
        #guide-panel {
          order: 3;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>{{ app_name }} · Prompt 管理控制台</h1>
      <div class="header-actions">
        <span id="login-state">未登录</span>
        <button id="btn-logout" class="secondary compact" type="button">退出登录</button>
      </div>
    </header>

    <main>
      <section id="console">
        <aside id="profile-list" class="glass">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3>Prompt Profiles</h3>
            <button id="btn-refresh" class="secondary" type="button">刷新</button>
          </div>
          <div id="profiles-container"></div>
          <button id="btn-create" class="primary" type="button" style="margin-top:auto;">新建 Profile</button>
        </aside>

        <section id="editor-panel" class="glass">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
            <div>
              <h3 id="editor-title">请选择一个 Profile</h3>
              <p id="editor-subtitle" style="margin-top:-0.5rem;color:#64748b;font-size:0.85rem;">编辑后点击「发布更新」。</p>
            </div>
            <span id="last-updated" class="badge" hidden></span>
          </div>
          <form id="profile-form">
            <div class="field-group">
              <label for="field-key">Key</label>
              <input id="field-key" name="key" placeholder="例如：math" required />
            </div>
            <div class="field-group">
              <label for="field-display">显示名称</label>
              <input id="field-display" name="display_name" placeholder="例如：数学解析" required />
            </div>
            <div class="field-group">
              <label for="field-aliases">别名（逗号分隔）</label>
              <input id="field-aliases" name="aliases" placeholder="math, 数学, mathematics" />
            </div>
            <div class="field-group">
              <label for="field-system">系统模板</label>
              <textarea id="field-system" name="system_template" placeholder="系统提示词" required></textarea>
            </div>
            <div class="field-group">
              <label for="field-user">用户模板</label>
              <textarea id="field-user" name="user_template" placeholder="用户提示词" required></textarea>
            </div>
            <details class="field-group">
              <summary style="cursor:pointer;font-weight:600;">高级选项：Schema（可选）</summary>
              <p style="color:#64748b;font-size:0.85rem;margin:0.6rem 0;">如需调整结构化输出格式，请填写合法 JSON；留空则沿用默认结构。</p>
              <div class="actions" style="gap:0.6rem;margin:0.4rem 0 0.8rem;">
                <button id="btn-load-default-schema" class="secondary compact" type="button">填充默认 Schema</button>
              </div>
              <textarea id="field-schema" name="schema" placeholder="{\n  \"format\": { ... }\n}"></textarea>
            </details>
            <div class="field-group">
              <label for="field-comment">变更说明（用于审计）</label>
              <input id="field-comment" name="comment" placeholder="例如：新增数学模板" pattern="[A-Za-z0-9\u4e00-\u9fa5\s]*" title="仅支持中文、英文、数字和空格" />
            </div>
            <div class="actions">
              <button id="btn-save" class="primary" type="submit">发布更新</button>
              <button id="btn-reset" class="secondary" type="button">恢复默认</button>
              <button id="btn-delete" class="danger" type="button">删除配置</button>
            </div>
          </form>

          <section class="preview-panel" id="preview-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
              <h4 style="margin:0;">提示词预览</h4>
              <div class="preview-actions">
                <button id="btn-preview-run" class="secondary compact" type="button">生成预览</button>
                <button id="btn-preview-copy-system" class="secondary compact" type="button">复制系统 Prompt</button>
                <button id="btn-preview-copy-user" class="secondary compact" type="button">复制用户 Prompt</button>
              </div>
            </div>
            <div class="preview-meta" id="preview-meta">请填写 note_type 和标签后点击「生成预览」。</div>
            <div class="preview-controls">
              <div class="field-group">
                <label for="preview-note-type">note_type</label>
                <input id="preview-note-type" placeholder="默认使用当前 Profile 显示名称" />
              </div>
              <div class="field-group">
                <label for="preview-tags">标签（逗号分隔）</label>
                <input id="preview-tags" placeholder="示例：函数, 考点, 高频错题" />
              </div>
            </div>
            <div class="preview-outputs">
              <div class="preview-box">
                <h5>System Prompt</h5>
                <pre id="preview-system" class="preview-empty">尚未生成</pre>
              </div>
              <div class="preview-box">
                <h5>User Prompt</h5>
                <pre id="preview-user" class="preview-empty">尚未生成</pre>
              </div>
              <div class="preview-box">
                <h5>Schema</h5>
                <pre id="preview-schema" class="preview-empty">沿用默认 Schema</pre>
              </div>
            </div>
          </section>
        </section>

        <aside id="history-panel" class="glass">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>版本历史</h3>
            <button id="btn-history-refresh" class="secondary" type="button">刷新</button>
          </div>
          <div id="history-list"></div>
        </aside>

        <aside id="guide-panel" class="glass">
          <h3>操作指南</h3>
          <ul>
            <li><strong>发布流程：</strong>选中 Profile → 修改内容 → 填写「变更说明」 → 点击「发布更新」。</li>
            <li><strong>回滚流程：</strong>在右侧历史中选择时间点，点击「恢复」。操作会记录到审计日志。</li>
            <li><strong>常用占位符：</strong> {note_type}、{tags_text}、{tags}。</li>
            <li><strong>Schema 说明：</strong>默认结构包括 title/summary/raw_text/sections/key_points/study_advice/meta，如需扩展请复制默认示例后修改。</li>
            <li><strong>安全提示：</strong>密钥请勿外泄，可通过更换密钥踢出旧会话。</li>
          </ul>
        </aside>
      </section>
    </main>

    <div id="notification" class="notification" style="display:none;"></div>

    <script>
    const API_BASE = "{{ api_base }}";
    const LOGIN_URL = "/admin";
    const AUTO_LOGIN_KEY = "adminAutoLogin";
    const SESSION_FLAG = "adminSessionAuthorized";
    const CONSOLE_URL = "/admin/console";
    const ACTOR_PATTERN = /^[A-Za-z0-9\u4e00-\u9fa5]+$/;

      const state = {
        key: null,
        actor: null,
        profiles: [],
        current: null,
        versions: [],
      };

  const loginStateEl = document.getElementById("login-state");
      const logoutBtn = document.getElementById("btn-logout");
      const notificationEl = document.getElementById("notification");
      const profilesContainer = document.getElementById("profiles-container");
      const historyList = document.getElementById("history-list");
      const editorTitle = document.getElementById("editor-title");
      const editorSubtitle = document.getElementById("editor-subtitle");
      const lastUpdated = document.getElementById("last-updated");
      const form = document.getElementById("profile-form");
      const schemaField = document.getElementById("field-schema");
      const previewPanel = document.getElementById("preview-panel");
      const previewMeta = document.getElementById("preview-meta");
      const previewNoteTypeInput = document.getElementById("preview-note-type");
      const previewTagsInput = document.getElementById("preview-tags");
      const previewSystem = document.getElementById("preview-system");
      const previewUser = document.getElementById("preview-user");
      const previewSchema = document.getElementById("preview-schema");
      const btnPreviewRun = document.getElementById("btn-preview-run");
      const btnPreviewCopySystem = document.getElementById("btn-preview-copy-system");
      const btnPreviewCopyUser = document.getElementById("btn-preview-copy-user");
      const btnLoadDefaultSchema = document.getElementById("btn-load-default-schema");

      const hasSessionFlag = sessionStorage.getItem(SESSION_FLAG) === "1";
      sessionStorage.removeItem(SESSION_FLAG);
      const autoLoginEnabled = localStorage.getItem(AUTO_LOGIN_KEY) === "1";

      if (!hasSessionFlag && !autoLoginEnabled) {
        window.location.replace(LOGIN_URL);
      }

      if (window.location.search.includes("authorized=1")) {
        history.replaceState(null, "", CONSOLE_URL);
      }

      function showNotification(message, type = "success") {
        notificationEl.textContent = message;
        notificationEl.className = `notification ${type}`;
        notificationEl.style.display = "block";
        notificationEl.style.opacity = "1";
        setTimeout(() => {
          notificationEl.style.opacity = "0";
          setTimeout(() => (notificationEl.style.display = "none"), 300);
        }, 2600);
      }

      function ensureCredentials() {
        const storedKey = localStorage.getItem("adminKey");
        const storedActor = localStorage.getItem("adminActor");
        if (!storedKey || !storedActor || !ACTOR_PATTERN.test(storedActor)) {
          localStorage.removeItem("adminKey");
          localStorage.removeItem("adminActor");
          window.location.replace(LOGIN_URL);
          throw new Error("缺少管理员登录信息");
        }
        state.key = storedKey;
        state.actor = storedActor;
        loginStateEl.textContent = `已登录 · ${state.actor}`;
        loginStateEl.title = `当前操作员：${state.actor}`;
      }

      function normalizeComment(value) {
        if (value === null || value === undefined) {
          return undefined;
        }
        const trimmed = value.trim();
        if (!trimmed) {
          return undefined;
        }
        const COMMENT_PATTERN = /^[A-Za-z0-9\u4e00-\u9fa5\s]+$/;
        if (!COMMENT_PATTERN.test(trimmed)) {
          throw new Error("备注仅支持中文、英文、数字和空格");
        }
        return trimmed;
      }

      function parseTagsInput(value) {
        if (!value) {
          return [];
        }
        return value
          .split(",")
          .map((token) => token.trim())
          .filter((token) => token.length > 0);
      }

      async function apiFetch(path, options = {}) {
        if (!state.key || !state.actor) {
          throw new Error("尚未登录");
        }
        const headers = new Headers(options.headers || {});
        headers.set("Content-Type", "application/json");
        headers.set("X-Admin-Key", state.key);
        headers.set("X-Admin-Actor", state.actor);
        const response = await fetch(`${API_BASE}${path}`, {
          ...options,
          headers,
        });
        if (!response.ok) {
          let detail = "请求失败";
          try {
            const payload = await response.json();
            detail = payload.detail || JSON.stringify(payload);
          } catch (err) {
            detail = response.statusText;
          }
          throw new Error(detail);
        }
        if (response.status === 204) {
          return null;
        }
        return response.json();
      }

      function setPreviewAvailability(enabled) {
        previewNoteTypeInput.disabled = !enabled;
        previewTagsInput.disabled = !enabled;
        btnPreviewRun.disabled = !enabled;
        btnLoadDefaultSchema.disabled = !enabled;
        if (!enabled) {
          previewNoteTypeInput.value = "";
          previewTagsInput.value = "";
          btnPreviewCopySystem.disabled = true;
          btnPreviewCopyUser.disabled = true;
        }
      }

      function resetPreview(message = "请填写 note_type 和标签后点击「生成预览」。") {
        previewMeta.textContent = message;
        previewSystem.textContent = "尚未生成";
        previewUser.textContent = "尚未生成";
        previewSchema.textContent = "沿用默认 Schema";
        previewSystem.classList.add("preview-empty");
        previewUser.classList.add("preview-empty");
        previewSchema.classList.add("preview-empty");
        btnPreviewCopySystem.disabled = true;
        btnPreviewCopyUser.disabled = true;
      }

      function applyPreviewResult(result) {
        const tagsText = result.tags && result.tags.length ? result.tags.join(", ") : "无";
        previewMeta.textContent = `note_type：${result.note_type} · 标签：${tagsText}`;
        previewSystem.textContent = result.system_prompt || "(空)";
        previewUser.textContent = result.user_prompt || "(空)";
        const schemaText = result.schema ? JSON.stringify(result.schema, null, 2) : "沿用默认 Schema";
        previewSchema.textContent = schemaText;
        previewSystem.classList.toggle("preview-empty", !result.system_prompt);
        previewUser.classList.toggle("preview-empty", !result.user_prompt);
        previewSchema.classList.toggle("preview-empty", !result.schema);
        btnPreviewCopySystem.disabled = !result.system_prompt;
        btnPreviewCopyUser.disabled = !result.user_prompt;
      }

      async function copyPreviewContent(element, successMessage) {
        const content = (element.textContent || "").trim();
        if (!content || element.classList.contains("preview-empty")) {
          showNotification("暂无内容可复制", "error");
          return;
        }
        try {
          await navigator.clipboard.writeText(content);
          showNotification(successMessage);
        } catch (error) {
          const textarea = document.createElement("textarea");
          textarea.value = content;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          try {
            document.execCommand("copy");
            showNotification(successMessage);
          } catch (err) {
            showNotification("复制失败，请手动复制", "error");
          }
          document.body.removeChild(textarea);
        }
      }

      async function runPreview(auto = false) {
        if (!state.current) {
          if (!auto) {
            showNotification("请先选择一个 Profile", "error");
          }
          return;
        }
        const noteTypeValue = previewNoteTypeInput.value.trim();
        const payload = {
          note_type: noteTypeValue || null,
          tags: parseTagsInput(previewTagsInput.value),
        };
        try {
          const result = await apiFetch(`/prompts/${encodeURIComponent(state.current.key)}/preview`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          applyPreviewResult(result);
          if (!auto) {
            showNotification("预览已生成");
          }
        } catch (error) {
          resetPreview(auto ? `预览失败：${error.message}` : "请填写 note_type 和标签后点击「生成预览」。");
          if (!auto) {
            showNotification(error.message, "error");
          }
        }
      }

      function renderProfiles() {
        profilesContainer.innerHTML = "";
        if (state.profiles.length === 0) {
          profilesContainer.innerHTML = '<p style="color:#64748b;">暂无配置，请点击右侧新建。</p>';
          return;
        }
        state.profiles.forEach((profile) => {
          const card = document.createElement("div");
          card.className = "profile-item" + (state.current && state.current.key === profile.key ? " active" : "");
          const metaBits = [];
          if (profile.last_version) metaBits.push(`#${profile.last_version}`);
          if (profile.last_actor) metaBits.push(profile.last_actor);
          card.innerHTML = `<strong>${profile.display_name}</strong><small>${profile.key}</small>` +
            (metaBits.length ? `<small style="color:#1d4ed8;">${metaBits.join(" · ")}</small>` : "");
          if (profile.last_comment) {
            card.title = `最近备注：${profile.last_comment}`;
          }
          card.addEventListener("click", () => selectProfile(profile.key));
          profilesContainer.appendChild(card);
        });
      }

      function populateForm(profile) {
        document.getElementById("field-key").value = profile.key;
        document.getElementById("field-display").value = profile.display_name || "";
        document.getElementById("field-aliases").value = (profile.aliases || []).join(", ");
        document.getElementById("field-system").value = profile.system_template || "";
        document.getElementById("field-user").value = profile.user_template || "";
        schemaField.value = profile.schema ? JSON.stringify(profile.schema, null, 2) : "";
        document.getElementById("field-comment").value = "";
        editorTitle.textContent = `${profile.display_name} (${profile.key})`;
        editorSubtitle.textContent = profile.last_comment ? `最近备注：${profile.last_comment}` : "编辑完成后发布即可热更新";
        const metaParts = [];
        if (profile.last_version) metaParts.push(`版本 #${profile.last_version}`);
        if (profile.updated_at) metaParts.push(new Date(profile.updated_at).toLocaleString());
        if (profile.last_actor) metaParts.push(`操作者：${profile.last_actor}`);
        lastUpdated.textContent = metaParts.length ? metaParts.join(" · ") : `更新: ${new Date(profile.updated_at).toLocaleString()}`;
        lastUpdated.hidden = false;
        lastUpdated.title = profile.last_comment ? `最近备注：${profile.last_comment}` : "";
        document.getElementById("btn-delete").disabled = profile.key === "general";
        setPreviewAvailability(true);
        const defaultNoteType = profile.display_name || profile.key;
        previewNoteTypeInput.value = defaultNoteType;
        previewTagsInput.value = "";
        resetPreview(`默认 note_type：${defaultNoteType} · 点击「生成预览」查看渲染结果`);
        loadVersions(profile.key);
        runPreview(true).catch((error) => console.warn("预览失败", error));
      }

      function clearForm() {
        form.reset();
        editorTitle.textContent = "新建 Profile";
        editorSubtitle.textContent = "请填写全部必填项后发布";
        lastUpdated.hidden = true;
        document.getElementById("btn-delete").disabled = true;
        historyList.innerHTML = '<p style="color:#64748b;">保存后自动生成版本历史</p>';
        setPreviewAvailability(false);
        resetPreview("保存后可生成预览");
      }

      async function refreshProfiles() {
        try {
          const data = await apiFetch("/prompts");
          state.profiles = data.profiles;
          renderProfiles();
          if (!state.current && state.profiles.length > 0) {
            await selectProfile(state.profiles[0].key);
          }
        } catch (error) {
          console.error(error);
          showNotification(error.message, "error");
        }
      }

      async function selectProfile(key) {
        try {
          const profile = await apiFetch(`/prompts/${encodeURIComponent(key)}`);
          state.current = profile;
          populateForm(profile);
          renderProfiles();
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      async function loadVersions(key) {
        try {
          const versions = await apiFetch(`/prompts/${encodeURIComponent(key)}/versions`);
          state.versions = versions;
          renderHistory();
        } catch (error) {
          historyList.innerHTML = `<p style="color:#dc2626;">加载历史失败：${error.message}</p>`;
        }
      }

      function renderHistory() {
        historyList.innerHTML = "";
        if (!state.versions || state.versions.length === 0) {
          historyList.innerHTML = '<p style="color:#64748b;">暂无历史记录</p>';
          return;
        }
        state.versions.forEach((item) => {
          const card = document.createElement("div");
          card.className = "history-item";
          const actor = item.actor || "未知";
          const comment = item.comment || "(未填写说明)";
          const time = new Date(item.created_at).toLocaleString();
          card.innerHTML = `
            <div class="history-meta">
              <span>版本 #${item.version}</span>
              <span>${time}</span>
            </div>
            <p style="margin:0.6rem 0;color:#334155;">${comment}</p>
            <p style="margin:0;color:#64748b;font-size:0.85rem;">操作者：${actor}</p>
            <div class="actions" style="margin-top:0.8rem;">
              <button class="secondary" type="button">查看 JSON</button>
              <button class="primary" type="button">恢复到此版本</button>
            </div>
          `;
          const [viewBtn, restoreBtn] = card.querySelectorAll("button");
          viewBtn.addEventListener("click", () => {
            const pretty = JSON.stringify(item.payload, null, 2);
            navigator.clipboard.writeText(pretty)
              .then(() => {
                showNotification("版本 JSON 已复制到剪贴板");
              })
              .catch(() => {
                window.prompt("版本 JSON", pretty);
              });
          });
          restoreBtn.addEventListener("click", async () => {
            if (!confirm(`确认恢复到版本 #${item.version}?`)) return;
            let comment;
            try {
              comment = normalizeComment(prompt("请输入此次恢复的说明", `restore ${item.version}`));
            } catch (error) {
              showNotification(error.message, "error");
              return;
            }
            try {
              await apiFetch(`/prompts/${encodeURIComponent(item.profile_key)}/versions/${item.id}/restore`, {
                method: "POST",
                body: JSON.stringify({ comment }),
              });
              showNotification("恢复成功");
              await refreshProfiles();
              await selectProfile(item.profile_key);
            } catch (error) {
              showNotification(error.message, "error");
            }
          });
          historyList.appendChild(card);
        });
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const key = formData.get("key").trim();
        if (!key) {
          showNotification("Key 不能为空", "error");
          return;
        }
        const payload = {
          key,
          display_name: formData.get("display_name").trim(),
          system_template: formData.get("system_template").trim(),
          user_template: formData.get("user_template").trim(),
          aliases: formData.get("aliases").split(",").map((v) => v.trim()).filter(Boolean),
        };
        try {
          const commentValue = normalizeComment(formData.get("comment"));
          if (commentValue !== undefined) {
            payload.comment = commentValue;
          }
        } catch (error) {
          showNotification(error.message, "error");
          return;
        }
        const schemaText = formData.get("schema").trim();
        if (schemaText) {
          try {
            payload.schema = JSON.parse(schemaText);
          } catch (error) {
            showNotification("Schema 不是合法 JSON", "error");
            return;
          }
        }
        try {
          const result = await apiFetch("/prompts", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          showNotification("发布成功");
          await refreshProfiles();
          await selectProfile(result.key);
        } catch (error) {
          showNotification(error.message, "error");
        }
      });

      document.getElementById("btn-refresh").addEventListener("click", refreshProfiles);
      document.getElementById("btn-create").addEventListener("click", () => {
        state.current = null;
        clearForm();
      });

      btnPreviewRun.addEventListener("click", () => runPreview(false));
      btnPreviewCopySystem.addEventListener("click", () => copyPreviewContent(previewSystem, "系统 Prompt 已复制"));
      btnPreviewCopyUser.addEventListener("click", () => copyPreviewContent(previewUser, "用户 Prompt 已复制"));
      btnLoadDefaultSchema.addEventListener("click", async () => {
        if (!state.current) {
          showNotification("请先选择一个 Profile", "error");
          return;
        }
        try {
          const result = await apiFetch(`/prompts/${encodeURIComponent(state.current.key)}/default`);
          const defaultPayload = result.payload || {};
          if (defaultPayload.schema) {
            schemaField.value = JSON.stringify(defaultPayload.schema, null, 2);
            showNotification("已填充默认 Schema");
          } else {
            schemaField.value = "";
            showNotification("默认配置未定义额外 Schema，已恢复基础结构");
          }
        } catch (error) {
          showNotification(error.message, "error");
        }
      });

      document.getElementById("btn-delete").addEventListener("click", async () => {
        if (!state.current) {
          showNotification("请先选择一个 Profile", "error");
          return;
        }
        if (state.current.key === "general") {
          showNotification("general 配置禁止删除", "error");
          return;
        }
        if (!confirm(`确认删除 ${state.current.display_name} (${state.current.key})?`)) return;
        let comment;
        try {
          comment = normalizeComment(prompt("删除原因", "delete"));
        } catch (error) {
          showNotification(error.message, "error");
          return;
        }
        try {
          await apiFetch(`/prompts/${encodeURIComponent(state.current.key)}`, {
            method: "DELETE",
            body: JSON.stringify({ comment }),
          });
          showNotification("删除成功");
          state.current = null;
          await refreshProfiles();
          clearForm();
        } catch (error) {
          showNotification(error.message, "error");
        }
      });

      document.getElementById("btn-reset").addEventListener("click", async () => {
        if (!state.current) {
          showNotification("请先选择一个 Profile", "error");
          return;
        }
        if (!confirm(`确认恢复 ${state.current.display_name} 的默认配置?`)) return;
        let comment;
        try {
          comment = normalizeComment(prompt("此次恢复的说明", "reset"));
        } catch (error) {
          showNotification(error.message, "error");
          return;
        }
        try {
          const result = await apiFetch(`/prompts/${encodeURIComponent(state.current.key)}/reset`, {
            method: "POST",
            body: JSON.stringify({ comment }),
          });
          showNotification("已恢复默认配置");
          await refreshProfiles();
          await selectProfile(result.key);
        } catch (error) {
          showNotification(error.message, "error");
        }
      });

      document.getElementById("btn-history-refresh").addEventListener("click", () => {
        if (state.current) {
          loadVersions(state.current.key);
        }
      });

      btnPreviewCopySystem.disabled = true;
      btnPreviewCopyUser.disabled = true;

      logoutBtn.addEventListener("click", (event) => {
        event.preventDefault();
        logoutBtn.disabled = true;
        logoutBtn.textContent = "正在退出...";
        localStorage.removeItem("adminKey");
        localStorage.removeItem("adminActor");
        localStorage.removeItem(AUTO_LOGIN_KEY);
        sessionStorage.removeItem(SESSION_FLAG);
        state.key = null;
        state.actor = null;
        showNotification("已退出登录");
        setTimeout(() => {
          window.location.href = LOGIN_URL;
        }, 150);
      });

      try {
        ensureCredentials();
      } catch (error) {
        console.warn(error.message);
        return;
      }

      setPreviewAvailability(false);
      resetPreview();
      refreshProfiles();
    </script>
  </body>
</html>
