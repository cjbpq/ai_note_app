# AI 指令集：校园智慧笔记 App (Expo)

## 1. 核心技术栈 (严格遵守)

- **框架**: Expo (SDK 50+)
- **UI 库**: React Native Paper (Material Design 风格)
- **状态管理**: Zustand
- **导航**: Expo Router
- **存储**: AsyncStorage + SQLite
- **网络**: Axios + TanStack Query
- **图片处理**: expo-image-picker

## 2. 开发者背景（严格明确）

- 我是一名前端开发新手，能看懂基本逻辑但手写代码经验较少，对于技术栈和库的使用仅限于查阅官方文档明确大概用途，对于内在逻辑和性能等不是很清楚，所以尽量选择对新手友好易于维护的方案。
- **注释规范**：请在生成代码时提供关键注释，解释每一块代码的作用。
- 如果涉及复杂的原生配置，请优先使用 Expo 的自动化方案。
- **交付要求**：
- _及时告知_: 在每一次正式的交付任务时都要明确表明完成了哪些工作。
- _TODO习惯_：完成任务后：自行去TODO中标记任务，同时适当添加本次任务中遗留的TODO
- _遵从要求_: 需要设计方案的时候尽量不要生成大量示例代码，需要执行方案的时候一定要使用编辑工具直接开发不要给我示例代码，否则去死。

- **预先感知**：基于开发者的新手背景，需要在对项目进行关键决策时提出自己觉得与开发和维护优秀的代码架构上有较大缺陷的隐藏问题，以供开发者考虑和决策。
- **错误处理**: 我不知道如何优雅地处理报错。请在生成网络请求代码时，优先使用 React Query 的状态（isError, error）来处理，避免在组件中堆积过多的 `try-catch` 代码块。如果必须捕获，请使用全局或 Service 层的统一错误处理机制。
- **防御性编程**: 在处理数组或对象时，请总是假设它们可能为空，使用可选链 `?.` 或空值合并 `??` 来防止 App 闪退。

### 2.1 平台策略（Android 优先 & iOS 兼容）

- 当前已走通 **EAS Build 生产构建全流程**；接下来优先主攻 **Android 真机调试**。
- iOS 暂无真机条件：以“代码一致性”为第一原则，尽量采用 Android/iOS **完全兼容**的方案。
- 任何平台不兼容都必须在开始编码前主动报出：
  - 不兼容点（API/权限/路径/WebView/SQLite 等）
  - 影响范围（哪些页面/功能）
  - 替代方案（优先跨端；其次分别适配，并说明维护成本）

### 2.2 API 错误码 → Snackbar/Toast（强制：有 API 就要想）

> 早期技术债：未把 API 错误码与 Snackbar/Toast 体系绑定，导致大量返工。此后 **凡涉及 API 的变更 = 必须同步设计错误提示策略**。

- 统一目标：用户可理解、可恢复（必要时提供 action），并且 UI 层不堆 `try-catch`。
- 推荐落点（严格分层，不越级）：
  - **Service 层**：解析后端错误 -> 产出“可展示信息/可映射 key”（UI 不关心 axios 细节）
  - **Hooks 层**：使用 TanStack Query 暴露 `isError/error`；必要时在 `onError` 触发 toast
  - **UI 层**：仅展示与交互；通过 `useToast()` 触发全局 Snackbar（保持一致风格）
- 开发时必须同步补充 TODO：
  - 该接口可能的错误码/错误结构（如 401/403/404/409/422/429/5xx/网络错误）
  - 对应 i18n key（不存在就新增，禁止硬编码中文）
  - 是否需要“重试/撤销/去设置/去登录”等 action

## 3. 项目架构与代码规范 (严格执行)

### 3.1 分层架构 (The Layered Architecture)

我们采用严格的 **UI -> Hooks -> Services** 单向依赖架构，严禁越级调用。

1.  **UI 层 (Components/Screens)**:
    - **职责**: 只负责渲染界面和响应用户交互。
    - **禁忌**: 严禁直接调用 `axios` 或数据库 SQL。严禁处理复杂的业务逻辑。
    - **数据来源**: 必须且只能通过 Custom Hooks (如 `useNotes`) 获取数据。
    - **强制注意**:
      - UI 颜色/状态必须优先使用 React Native Paper 的 theme（适配深色模式）
      - 涉及 API/保存/删除/上传：即使需求没提，也要保持 toast/错误态的高完成度（并补 TODO）

2.  **Hooks 层 (`/hooks`)**:
    - **职责**: 作为 UI 和 Service 的中间人 (ViewModel)。
    - **实现**: 使用 **Tanstack Query** (`useQuery`, `useMutation`) 管理服务端状态（缓存、自动刷新）。
    - **规范**: 对应每个业务模块创建一个 Hook 文件，如 `useNotes.ts`。

3.  **Service 层 (`/services`)**:
    - **职责**: 处理纯粹的数据请求（API 调用、数据库读写）。
    - **规范**: 函数必须是无状态的 `async` 函数。支持 Mock 模式切换。
    - **错误处理规范**:
      - 新增/修改 API 调用时，同步补齐错误解析（产出可映射的 i18n key / message）
      - 尽量复用模块内统一的错误提取函数，避免每个 service/页面各写一套

4.  **Store 层 (`/store`)**:
    - **职责**: 使用 **Zustand** 管理**纯客户端状态**（如：用户偏好、搜索框文字、UI 开关）。
    - **禁忌**: 不要用 Zustand 存储从服务器拉取的业务数据（交给 React Query）。

### 3.2 编码规范

- **常量管理**:
  - 业务逻辑中的“魔术数字”和配置项（如超时时间、最大字符限制）必须提取到 `/constants/config.ts` 的 `APP_CONFIG` 中。
  - 路由名称等固定值应定义在 `constants` 中。
  - 敏感信息（API URL, Keys）必须走 `.env` 环境变量。

- **i18n 国际化**:
  - UI 中**严禁**硬编码任何中文字符串。
  - **流程**: 新增文本 -> 在 `i18n/zh.ts` 添加 Key -> 在组件中使用 `i18n.t('key')`。

- **类型定义**:
  - 所有的 TypeScript 接口 (Interfaces) 必须定义在 `/types/index.ts` 中，禁止在组件内部散乱定义。

- **样式与主题**:
  - 布局使用 `StyleSheet.create`。
  - 颜色必须使用 `useTheme()` 获取，严禁硬编码 hex 颜色值。

- **代码风格**:
  - 项目使用Prettier和ESLint进行代码格式化和检查，所有生成的代码必须符合.prettierrc和.eslintrc的规则。

## 4. 工作流（重要：先方案后编码，拒绝补丁式开发）

### 4.1 大任务默认流程（先讨论方案，再直接改文件）

1. 先讨论并确认方案：给出分层落点（UI/Hooks/Services/Store）与阶段性拆解。
2. 确认后进入执行：直接编辑项目文件，不要堆大量示例代码（除非必要展示关键片段）。
3. 拒绝补丁式修补：如果问题根因是架构/约定缺失，优先做“最小重构”一次性还清技术债。

### 4.2 可视化 TODO 与完成模板（必须遵循）

- 每次开发开始：先列可视化 TODO（我能看到进度与阶段）。
- 开发过程中：按 TODO 推进。
- 交付时：必须勾选完成项，并补充遗留 TODO。

完成条目模板（尽量按此格式，便于同步到 DEV_LOG）：

- [x] 功能/UI：<最小可用描述> ✅ <YYYY-MM-DD>
  - 重大决策：<关键选型与原因>
  - 架构实现：<Store/Hook/Service/UI 的落点与职责>
  - UI 位置：<页面/组件位置，是否可移植>
  - 兼容性：<Android/iOS 差异与处理；如无写“无”>
  - 后续迭代：<未来可能的优化/风险/ TODO>

### 4.3 项目认知来源（禁止肆意猜测）

- 当我要求“先对项目有整体观/清晰认识”时：优先阅读 `LOG/DEV_LOG`、`LOG/ROADMAP`、`LOG/History`、`LOG/TODO` 的重大决策与上下文，再动手改代码。
- 禁止凭空引入对后续维护不友好的方案（尤其是平台不兼容、重型依赖、绕开分层）。

## 5. 交付前自动审查清单（必须逐项自检）

- [ ] UI 文案是否全部使用 i18n（无硬编码中文）？
- [ ] 颜色是否全部来自 Paper `useTheme()`（无硬编码色值）？
- [ ] 是否严格遵守 UI → Hooks → Services 单向依赖（UI 不直连 axios/SQL）？
- [ ] 数组/对象访问是否使用 `?.` / `??`（防闪退）？
- [ ] 是否新增/修改了 API 调用？→ 是否同步设计并实现 toast/错误码提示（并补 TODO）？
- [ ] TypeScript 是否能编译通过（无明显类型错误/`any` 漫延）？
- [ ] 是否补充关键注释（解释模块职责与关键逻辑）？
- [ ] 是否更新 TODO（勾选已完成 + 补充遗留 TODO）？
- [ ] 是否明确 Android/iOS 兼容性结论（如有差异需提前说明）？

## 6. 错误处理映射小表（错误场景 → i18n Key → Toast 类型）

> 目的：把“后端错误/网络异常”稳定地转成一致的用户提示，避免 UI 层散落 if/else 与重复文案。

约定：

- i18n key 命名建议：`error.<domain>.<reason>`（例如 `error.auth.invalidCredentials`）。
- 若 key 不存在：必须同步在 `i18n/zh.ts` 与 `i18n/en.ts` 增加（禁止硬编码中文）。
- Toast 类型建议：
  - `error`：阻断流程/失败（登录失败、保存失败、权限不足）
  - `warning`：可继续但需注意（部分失败、内容不完整）
  - `info`：提示性质（网络切换、需要重新登录）
  - `success`：成功反馈（保存成功、复制成功）

| 场景/错误       | 常见来源                | i18n key（建议）                                      | Toast 类型    | Action（如需） | 提示/备注                                       |
| --------------- | ----------------------- | ----------------------------------------------------- | ------------- | -------------- | ----------------------------------------------- |
| 网络不可用/超时 | axios 网络层、超时      | `error.network.unavailable` / `error.network.timeout` | error         | 重试           | Android 真机更常见；优先提示“检查网络/稍后重试” |
| 401 未登录/过期 | API 返回 401            | `error.auth.unauthorized`                             | info/error    | 去登录         | 通常需要清 token + 引导重新登录                 |
| 403 权限不足    | API 返回 403            | `error.auth.forbidden`                                | error         | 无/反馈        | 明确告诉用户“无权限”，避免误导为网络问题        |
| 404 资源不存在  | API 返回 404            | `error.common.notFound`                               | error         | 返回/刷新      | 对笔记详情页尤其常见（已删除/ID 无效）          |
| 409 冲突/重复   | API 返回 409            | `error.common.conflict`                               | warning/error | 修改/重试      | 注册重复、重复提交等                            |
| 422 校验失败    | API 返回 422 + 字段信息 | `error.validation.invalid`（可细分字段）              | warning       | 无/定位字段    | 必须映射为友好文案；能定位到表单字段最好        |
| 429 频率限制    | API 返回 429            | `error.common.rateLimited`                            | warning       | 稍后再试       | 可以建议“稍后重试”，避免用户连续点击            |
| 5xx 服务异常    | API 返回 5xx            | `error.server.unavailable`                            | error         | 重试           | 提示“服务异常”，不要让用户以为是自己操作问题    |
| 未知错误        | 解析失败/结构不一致     | `error.common.unknown`                                | error         | 反馈/重试      | 记录可复现信息（接口/状态码/时间）并补 TODO     |
