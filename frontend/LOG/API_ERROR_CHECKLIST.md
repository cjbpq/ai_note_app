# API 接口错误处理体系检查表（UI 手工验收）

> 目标：在 App UI 层逐项验证“错误码 → i18n 文案 → Toast/ErrorScreen/字段定位”是否生效。
> 适用版本：当前 `main` 工作区（已接入统一 `ServiceError` 映射）。

## 0. 验收前准备

- [ ] 设备：Android 真机（主验收）
- [ ] 网络：可切换 Wi-Fi/移动网/飞行模式
- [ ] 账号：准备 1 个可登录账号 + 1 个未注册账号
- [ ] 数据：至少 1 条可访问笔记
- [ ] 记录方式：每条用“通过/失败 + 截图 + 备注”

---

## 1. 登录/注册（字段定位 + 友好提示）

| 编号    | 页面 | 触发方式                               | 预期表现（UI）                                                    | 结果 |
| ------- | ---- | -------------------------------------- | ----------------------------------------------------------------- | ---- |
| AUTH-01 | 登录 | 输入错误密码登录                       | 显示错误 Toast（`error.auth.invalidCredentials`），不闪退，不跳页 | [ ]  |
| AUTH-02 | 登录 | 提交空值/非法值（触发 422）            | 对应输入框显示 `error` 状态 + 字段级 HelperText                   | [ ]  |
| AUTH-03 | 登录 | 断网后登录                             | 显示网络不可用 Toast（`error.network.unavailable`）               | [x]  |
| AUTH-04 | 注册 | 使用已存在用户名注册（若后端返回 409） | Toast 显示“用户名已存在”                                          | [ ]  |
| AUTH-05 | 注册 | 触发 422（如非法邮箱）                 | 对应字段出现错误定位，文案为 i18n 友好提示                        | [ ]  |
| AUTH-06 | 注册 | 高频点击触发限流（若后端返回 429）     | Toast 显示“操作过于频繁，请稍后再试”                              | [ ]  |

---

## 2. 上传/生成笔记（步骤级反馈 + 重试指引）

| 编号  | 页面     | 触发方式                        | 预期表现（UI）                                            | 结果 |
| ----- | -------- | ------------------------------- | --------------------------------------------------------- | ---- |
| UP-01 | 首页上传 | 正常上传并轮询完成              | 上传/处理中状态可见，成功后进入结果弹层                   | [x]  |
| UP-02 | 首页上传 | 上传时断网                      | Toast 显示网络不可用或超时，不崩溃                        | [x]  |
| UP-03 | 首页上传 | 上传非法文件/超限（若后端 400） | Toast 显示文件格式/大小错误（`error.upload.invalidFile`） | [ ]  |
| UP-04 | 首页上传 | 任务查询返回 404（无效 jobId）  | Toast 显示任务不存在（`error.upload.jobNotFound`）        | [ ]  |
| UP-05 | 首页上传 | 任务查询返回 403                | Toast 显示无权限访问任务（`error.upload.jobForbidden`）   | [ ]  |
| UP-06 | 首页上传 | 任务长期不完成直到超时          | Toast 显示任务超时（`error.upload.jobTimeout`）           | [ ]  |
| UP-07 | 首页上传 | 后端任务失败（status=failed）   | Toast 显示任务失败（`error.upload.jobFailed`）            | [ ]  |

---

## 3. 笔记详情（ErrorScreen 分支）

| 编号    | 页面     | 触发方式                    | 预期表现（UI）                                    | 结果 |
| ------- | -------- | --------------------------- | ------------------------------------------------- | ---- |
| NOTE-01 | 笔记详情 | 使用不存在 noteId 进入详情  | 展示 `ErrorScreen`（not found），有返回按钮       | [ ]  |
| NOTE-02 | 笔记详情 | 无权限 noteId（403）        | 展示 `ErrorScreen`（forbidden），有返回按钮       | [ ]  |
| NOTE-03 | 笔记详情 | 非 404 的临时错误（如断网） | 展示 `ErrorScreen`，可点击重试                    | [ ]  |
| NOTE-04 | 编辑保存 | 断网后保存                  | Toast 显示保存失败/网络错误，不闪退，编辑态可继续 | [ ]  |
| NOTE-05 | 删除笔记 | 删除不存在笔记（404）       | Toast 显示笔记不存在                              | [ ]  |

---

## 4. 通用网络层（全局反馈）

| 编号   | 范围     | 触发方式           | 预期表现（UI）                                        | 结果 |
| ------ | -------- | ------------------ | ----------------------------------------------------- | ---- |
| NET-01 | 任意 API | 飞行模式下触发请求 | Toast：`error.network.unavailable`                    | [ ]  |
| NET-02 | 任意 API | 人为制造慢网超时   | Toast：`error.network.timeout`                        | [ ]  |
| NET-03 | 任意 API | 服务端 5xx         | Toast：`error.server.unavailable`                     | [ ]  |
| NET-04 | 鉴权     | Token 过期后发请求 | 自动跳登录或提示重新登录（`error.auth.unauthorized`） | [ ]  |

---

## 5. Toast 队列策略（Error 优先）

| 编号     | 场景       | 操作步骤                      | 预期表现（UI）                 | 结果 |
| -------- | ---------- | ----------------------------- | ------------------------------ | ---- |
| TOAST-01 | Error 插队 | 先触发 info，再立刻触发 error | error 优先展示（可中断 info）  | [ ]  |
| TOAST-02 | 多条错误   | 连续触发 3 条 error           | 按优先策略展示，不丢失关键错误 | [ ]  |
| TOAST-03 | 普通队列   | 连续触发 success/info         | 按 FIFO 顺序展示               | [ ]  |

---

## 6. i18n 与防御性编程检查

- [ ] 所有错误提示均来自 i18n（无硬编码中文）
- [ ] 错误场景下页面不白屏、不崩溃
- [ ] 对象/数组空值路径访问稳定（`?.` / `??` 生效）

---

## 7. 验收结论模板（复制使用）

### 验收结果

- 日期：
- 设备：
- 版本：
- 通过率：`__/__`

### 未通过项

- 编号：
- 实际现象：
- 复现步骤：
- 截图/录屏：
- 建议修复层级（UI / Hook / Service / 后端）：

### 后续 TODO（建议）

- [ ] 补齐后端统一业务错误码（`code/message/details`）
- [ ] 为 409/429 提供稳定可识别的业务 code，减少状态码歧义
- [ ] 增加一条“半自动冒烟检查脚本”（可选）
