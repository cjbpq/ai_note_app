# � 项目任务清单 (TODO List)

> 历史已完成任务请查看 [History.md](History.md) | 长期规划请参考 [ROADMAP.md](ROADMAP.md)

------------------------------------分隔线---------------------------------------------------------

## 一、ROADMAP:阶段 2 — 体验打磨与错误处理闭环 🔧

**项目进度路线**

**目标**：把"能用"提升到"好用"—— 错误有提示、操作有反馈、表单有校验、关键路径无白屏。

### 2.1 错误处理体系补全

> Toast 基础设施已就绪，核心工作是逐模块把"错误码 → i18n key → toast 类型"串起来。

### 2.2 表单校验与输入体验

### 2.3 关键 UI/UX 修复

- [ ] 防御性编程扩展：将 `utils/safeData.ts` 复用到非 Note 模块（Scan/Auth/Settings）并补最小回归检查

### 2.4 Types 清理

- [ ] 审查 `types/index.ts`，移除不再使用的类型；补充缺失的 JSDoc

------------------------------------分隔线---------------------------------------------------------

## 二、即时TODO

**收集调试过程中的即使bug/新增功能**

- [x] **分类本地缓存账号隔离止血**：`local_new_categories` 改为 `local_new_categories_{userId}`，并清理历史全局 key ✅ 2026-02-25
- [x] **搜索历史本地缓存账号隔离止血**：`search_history` 改为 `search_history_{userId}`，并清理历史全局 key ✅ 2026-02-25

- [ ] **后端分类系统协同设计**：输出分类 CRUD 最小接口合同（字段、错误码、前端 i18n 映射、迁移策略）

- [ ] **useScanNotes 清理**：已标记 @deprecated，确认无回归风险后可安全删除
- [ ] **UX bug**:当用户上传单张从相册选择的手机完整截屏后，默认全屏裁剪导致无法正常裁剪
- [ ] **Toast 队列优化**: 评估高频触发时的消息堆积问题，考虑为 Error 消息增加时长或优先级。



------------------------------------分隔线---------------------------------------------------------

## 三、关键架构优化 (Refactoring & Tech Debt)

### 数学公式引擎 (Math Engine Iteration)

- [ ] **P1 (短期)**: 内容清洗管道 (Hook/Service 层预处理 LaTeX 分隔符)。
- [ ] **P1 (短期)**: 渲染失败兜底 (显示原始文本 + 错误标记上报)。
- [ ] **P2 (中期)**: 评估 MathJax v3 SVG 方案 (更高兼容性)。
- [ ] **P2 (中期)**: 全内容 WebView 渲染模式 (针对重公式长文)。
- [ ] **P3 (长期)**: 服务端预渲染 (SVG/PNG)。

### 离线优先架构 (Offline First)

- [ ] **离线刷新重构**: 本地优先读/写 -> 失败回滚 -> 后台同步队列。
- [ ] **Store 类型完善**: 完善 useScanStore, useUIStore 的 TypeScript 类型定义。
- [ ] **Token 刷新策略**: 添加 Token 主动刷新策略（过期前自动刷新）。
- [ ] **Secure Storage**: 生产环境评估 expo-secure-store 替代 AsyncStorage 存储 Token。

### 后端与接口

- [ ] **删除操作可恢复性**: 评估删除后 Snackbar `撤销` action（本地回滚 + 服务端补偿）方案。
- [ ] **注册逻辑完善**: 待后端接入真实邮箱限制。
- [ ] **错误响应结构标准化（后端协同）**: 建议后端补齐统一 `code/message/details`（含 409/429 业务码），前端可从状态码映射升级为业务码精确映射。
- [ ] **注册错误码临时兜底回收**: 当前前端将注册 400 临时映射为“用户名已存在”；待后端统一校验后改为按业务 `code` 精确提示。

> 提示：本次已先补齐“规范/映射表”；下一步建议把 422 映射落到具体模块（Service/Hooks）里，接入全局 toast。

------------------------------------分隔线---------------------------------------------------------

## 四、长期功能（迭代）计划

### 后续处理/优化：

- [ ]**全局导航体验优化**：在导航切换时，尤其是阅读列表相关界面总会出现退出白屏动画 考虑freezeonBlur等其他UI/UX优化阶段调优方案
- [ ] **多设备限制**: 开发后期需完成多设备同步登录限制。
- [ ] **Auth UI 升级（方案B）**: 登录/注册改为同壳层局部切换（固定标题/背景，仅表单区域动画）。
- [ ] **导出功能**: 支持导出笔记为 Image/PDF/Text。

- **收藏系统 (Favorites)**
  - [ ] **收藏列表页**: 独立的页面仅展示已收藏笔记。
  - [ ] **离线同步**: SQLite 缓存需同步 is_favorite 字段状态。

- **用户中心 & 设置 (Settings)**
  - [ ] 搭建用户中心各个基础跳转页面。
  - [ ] 配置 React Native Paper 全局字体 (Fonts) 规范。
  - [ ] 账户管理：重置密码

- **搜索功能优化 (Search)**
  - [ ] 搜索结果摘要片段展示（需后端返回匹配片段或前端截取）
  - [ ] 搜索历史点击后可直接跳转对应笔记（需存 noteId）；历史记录上限可配置化
  - [ ] 搜索页筛选区域 UI 精调（分类/标签 Chip 布局优化，当前为 MVP 功能优先）
  - [ ] 考虑笔记内容搜索（当前仅标题，正文搜索需评估 SQLite FTS5）
  - [ ] 骨架屏 SearchSkeleton 和 SearchError 组件保留未删，后续后端深度搜索可复用

- **分类功能优化**
- [ ] AI 智能分类推荐（根据笔记内容自动建议分类）
- [ ] 分类 Chip 数量过多时的折叠/展开优化
- [ ] 分类编辑/删除/重命名功能（需后端支持）
- [ ] Drawer 内收藏夹入口（已预留 i18n key，待收藏系统完善后接入）

- **多任务上传后续迭代**
- [ ] _多图场景大体积优化_；expo-image-manipulator 前端压缩
- [ ] _上传进度百分比_：当前仅显示"上传中/处理中"文字，后续可借助 axios onUploadProgress 展示真实百分比
- [ ] _任务持久化评估_：当前任务仅存于内存（Session 级），App 杀死即丢失；如用户反馈有需要可考虑 AsyncStorage 持久化
- [ ] **SSE 评估**：当后端 `/upload/jobs/{job_id}/stream` 稳定后，评估用 SSE 替代轮询（减少请求量 + 实时性更好）

- **全局Toast错误系统优化**
- [ ] **错误码精细化**：上传失败目前统一 toast，后续可按 413(文件过大)/415(格式不支持)/429(限流) 等给出差异化提示

### 功能拓展：
