# 🗺️ 智慧笔记 App 前端开发路线图 (Roadmap)

> **项目定位**：校园 AI 智慧笔记 App（前后端分离，本文件仅管前端）  
> **核心主链路**：拍照/选图 → 上传 → 后端 AI 生成结构化笔记 → 阅读/管理  
> **技术栈**：Expo SDK 50+ · React Native Paper · Zustand · TanStack Query · Expo Router · SQLite  
> **更新日期**：2026-02-14 &nbsp;|&nbsp; 进度对齐：DEV_LOG · TODO · History

---

## 〇、当前进度快照

> 以下清单基于 LOG/ 文件夹中的实际开发记录标注，✅ = 已落地可用，⚠️ = 部分完成。

| 能力                          | 状态 | 说明                                              |
| ----------------------------- | ---- | ------------------------------------------------- |
| 分层架构 UI→Hooks→Services    | ✅   | Zustand(客户端) + TanStack Query(服务端) 边界清晰 |
| 鉴权闭环 (Login/Register/401) | ✅   | Token 刷新 + 失败降级 + AuthEventEmitter 解耦     |
| 拍照/相册 双入口 + 权限分级   | ✅   | expo-image-picker，Android/iOS 权限文案已配置     |
| 上传 → 轮询 → AI 笔记生成     | ✅   | FormData + Job 轮询 + Store 状态机                |
| 笔记 CRUD + 多账号数据隔离    | ✅   | Query Key 注入 userId，登出清理缓存+SQLite        |
| 结构化笔记展示 (10+ 组件)     | ✅   | Summary/KeyPoints/Sections/StudyAdvice 等         |
| 数学公式离线渲染 (KaTeX)      | ✅   | CSS/JS/Fonts 全 Base64 内联，Zero-CDN             |
| 收藏功能 + 乐观更新           | ✅   | API + Local Cache + UI 一致                       |
| 全局 Toast/Snackbar           | ✅   | useToastStore + GlobalSnackbar                    |
| 深色模式                      | ✅   | Paper MD3 Light/Dark + Store 持久化               |
| 草稿自动保存/恢复             | ✅   | AsyncStorage 自动存/检测恢复                      |
| EAS 构建 + 真机 APK           | ✅   | eas.json 三套 profile，生产 APK 真机验证通过      |
| Types 对齐后端 Schema v3      | ✅   | snake→camelCase 映射完成（冗余类型待清理）        |
| 登录/注册失败 → 友好错误提示  | ⚠️   | Toast 基础设施就绪，具体错误码→i18n 映射待补全    |
| 编辑模式                      | ⚠️   | 元数据可编辑，结构化内容的编辑尚未实现            |
| 离线阅读                      | ⚠️   | SQLite 表&读写函数已有，系统化降级策略待做        |

---

## 一、阶段 1 — 基础架构与核心链路 ✅ (已完成)

> 2026-02-04 ~ 2026-02-09 完成，详见 History.md

**目标**：Happy Path 全面打通，不依赖 Mock，真机可运行。

- [x] Login → JWT 存储 → 拦截器注入 Token → 401 自动刷新/登出
- [x] 拍照/选图 → FormData → 上传 → 轮询 → 笔记回显
- [x] 笔记增删改查对接真实后端
- [x] 结构化笔记展示（10+ 组件 + i18n）
- [x] 数学公式离线渲染（KaTeX CSS/JS/Fonts Base64 内联）
- [x] 收藏功能 + 乐观更新
- [x] 全局 Snackbar/Toast 反馈体系
- [x] 深色模式 + 多账号数据隔离
- [x] EAS 生产构建 → APK 真机验证通过

---

## 二、阶段 2 — 体验打磨与错误处理闭环 🔧 (当前阶段)

**目标**：把"能用"提升到"好用"—— 错误有提示、操作有反馈、表单有校验、关键路径无白屏。

### 2.1 错误处理体系补全

> Toast 基础设施已就绪，核心工作是逐模块把"错误码 → i18n key → toast 类型"串起来。

- [x] **登录/注册**：密码错误、用户名已存在、格式校验不通过、限流 → 友好提示 + 表单字段定位
- [ ] **上传/生成笔记**：超时、断网、文件过大、Job 失败/排队中/限流 → 步骤级错误提示 + 重试引导
- [ ] **笔记详情**：404（已删除）、403（无权限）→ ErrorScreen + 返回引导
- [ ] **通用网络层**：断网检测 → 全局 toast/横幅；5xx → 统一"服务暂时不可用"
- [ ] Toast 队列策略评估（Error 优先/可中断 Info/避免高频堆积）

### 2.2 表单校验与输入体验

- [x] **登录表单**：非空校验 + 错误状态样式（Paper TextInput error prop）
- [x] **注册表单**：强密码规则 + 重复密码确认（纯前端侧）
- [x] 所有校验文案走 i18n

### 2.3 关键 UI/UX 修复

- [x] 登录/注册页底部 Tab 栏 主题未同步深色模式
- [x] 编辑模式体验重设计：至少保证"标题/标签/原文"可编辑 + 保存成功/失败闭环
- [x] 拍照结果页优化：折叠原文 / 结构化预览信息层级
- [ ] 防御性编程系统审查：逐页检查 `?.` / `??`（重点 structuredData 各字段渲染路径）

### 2.4 Types 清理

- [ ] 审查 `types/index.ts`，移除不再使用的类型；补充缺失的 JSDoc

---

## 三、阶段 3 — 数学公式引擎迭代 📐

**目标**：重公式/长文场景更稳、渲染失败可感知、性能可接受。

### P1 — 短期 (影响可用性)

- [ ] **内容清洗管道**：Hook/Service 层预处理 LaTeX 分隔符边界字符（防渲染炸裂）
- [ ] **渲染失败兜底**：显示原始文本 + 可复制 + 错误标记上报

### P2 — 中期 (影响体验)

- [ ] 长公式/大量公式场景：评估"全内容 WebView 渲染"或分段渲染
- [ ] 评估 MathJax v3 SVG 方案（更高兼容性，但包体积更大）
- [ ] WebView 高度自适应 / 滚动体验进一步优化

### P3 — 长期 (性能天花板)

- [ ] 可与后端同学协商：服务端预渲染公式为 SVG/PNG（彻底避免客户端 WebView 开销）

---

## 四、阶段 4 — 离线能力与数据策略 📶

**目标**：校园弱网/断网场景下，笔记仍可阅读，恢复网络后自动同步。

### 4.1 离线阅读 (最小闭环)

- [ ] **TanStack Query 缓存分级**：
  - 笔记列表：`staleTime` 5min + `gcTime` 30min，断网展示上次缓存
  - 笔记详情：优先 Query Cache → 其次 SQLite → 最后 API
- [ ] SQLite 作为离线 fallback（表结构已有，补齐"Query 失败时自动降级读取本地"逻辑）
- [ ] 断网状态检测 + 顶部横幅/toast 提示

### 4.2 数据同步 (后续迭代)

- [ ] 在线拉取 → 写入 SQLite（已部分实现，需系统化）
- [ ] 离线操作策略：先做"离线只读"（规避冲突解决复杂性）
- [ ] SQLite Schema 迁移策略（版本号 + 兼容默认值，避免全表 DROP 丢缓存数据）

---

## 五、阶段 5 — AI 能力扩展与生成体验 🤖

**目标**：AI 的"慢/不确定"在前端变成"可等待、可理解、可恢复"的体验。

### 5.1 生成管线 UX (前端重点)

- [ ] **生成中状态卡片**：上传后列表展示"正在生成..."占位卡（避免用户以为没反应）
- [ ] **Job 轮询优化**：指数退避 / 超时友好提示 / 失败可重试
- [ ] **生成失败恢复**：AI 失败时保留原图，引导"重新生成"而非丢失
- [ ] **429 / 配额限制**：前端展示"稍后再试" + 剩余次数提示（如后端提供）

### 5.2 AI 扩展功能 (依赖后端接口就绪)

- [ ] OCR / 纯文字识别（如后端提供独立端点 → 新增 Service + Hook）
- [ ] 智能分类/标签展示（`structured_data.meta.tags` 字段已有，UI 可先预留）
- [ ] 多图上传 → 合并笔记（需后端支持，前端预留多选 UI）

---

## 六、阶段 6 — 功能扩展与产品完善 🧩

**目标**：从"核心可用"走向"功能丰富"，补齐校园笔记的常用能力。

### 6.1 收藏与分类

- [ ] **收藏列表页**：独立页面仅展示已收藏笔记
- [ ] **分类/标签筛选**：按 subject/tags 过滤笔记列表

### 6.2 搜索

- [ ] 全局搜索入口（首页/阅读页 Appbar）
- [ ] 本地搜索 (SQLite LIKE) vs API 搜索 → 策略待定

### 6.3 用户中心 & 设置页

- [ ] 设置页功能入口：账号信息 / 清除缓存 / 关于 / 反馈
- [ ] 全局字体规范（React Native Paper Fonts 配置）
- [ ] 多语言切换 UI（i18n 基础已就绪）

### 6.4 导出与分享

- [ ] 导出笔记为 Image / PDF / 纯文本（选型：expo-print / expo-sharing）
- [ ] 分享到社交平台（评估国内社交 SDK 集成复杂度）

### 6.5 编辑体验进阶

- [ ] 结构化内容可编辑（当前仅元数据可编辑）
- [ ] 编辑 ↔ 预览切换（Markdown ↔ 结构化渲染）
- [ ] 版本历史 / 编辑冲突解决（远期）

---

## 七、阶段 7 — 性能优化与体验升级 ⚡

**目标**：数据量增长后不卡、视觉有质感。

- [ ] **骨架屏 (Skeleton)**：列表/详情加载时骨架占位（替代 ActivityIndicator）
- [ ] **长列表性能**：笔记量 > 100 时评估 `FlashList` 替换 `FlatList`
- [ ] **图片优化**：`expo-image` 替代 RN Image（缓存 / 渐进加载 / 占位图）
- [ ] **Bundle 分析**：检查 KaTeX Base64 资源对包体积影响，必要时调整策略
- [ ] **启动速度**：SplashScreen 过渡 + 非首屏资源懒加载

---

## 八、阶段 8 — 发布准备与运维 🚀

**目标**：小范围内测可控、线上问题可追踪、紧急修复可快速推送。

### 8.1 品牌与分发

- [x] app.json 基础标识（name/slug/bundleId/scheme）✅
- [ ] App 图标 (icon.png) + 启动图 (splash.png) 正式设计 + 多尺寸适配
- [ ] 版本号管理策略（semver + buildNumber 自增）
- [ ] Android 分发渠道：APK 直接分发（前期最灵活）

### 8.2 OTA 热更新

- [ ] 配置 `expo-updates`（仅修 JS/资源，原生变更走重新发版）
- [ ] 更新策略：启动时检查 / 后台静默下载 / 下次启动生效

### 8.3 错误监控

- [ ] **Sentry**：JS 报错 + 真机 Crash + 未处理 Promise rejection
- [ ] 关键操作埋点：上传成功率、生成成功率、平均等待时间

### 8.4 安全加固

- [ ] Token 存储迁移：评估 `expo-secure-store` 替代 AsyncStorage
- [ ] 网络安全：待后端部署 HTTPS 后关闭 `usesCleartextTraffic`

---

## 九、待决策事项汇总 🔑

> 不紧急但影响后续方向的问题，在相关阶段开始前做决定即可。

| #   | 问题                                                     | 影响阶段 | 建议                                        |
| --- | -------------------------------------------------------- | -------- | ------------------------------------------- |
| 1   | **离线策略**：离线只读 vs 离线编辑+同步？                | 阶段 4   | MVP 先只读，规避冲突解决复杂度              |
| 2   | **AI 能力边界**：后端已有/计划的 AI 接口清单？           | 阶段 5   | 与后端同学确认，前端按需对接                |
| 3   | **功能优先级**：收藏列表/搜索/导出/设置，先做哪个？      | 阶段 6   | 根据真机测试反馈决定                        |
| 4   | **Sentry 时机**：是否提前到阶段 2~3 接入？               | 阶段 8→2 | 建议提前，对真机调试帮助极大                |
| 5   | **Token 安全**：何时从 AsyncStorage 迁移到 SecureStore？ | 阶段 8   | 内测前完成即可                              |
| 6   | **HTTPS**：后端何时部署 HTTPS？                          | 阶段 8   | 与后端同学协商，影响前端关闭明文流量        |
| 7   | **多图上传**：后端是否支持/计划？                        | 阶段 5   | 前端先预留 UI，后端就绪再对接               |
| 8   | **KaTeX vs MathJax**：是否需要切换渲染引擎？             | 阶段 3   | 先优化 KaTeX 清洗管道，不稳定再评估 MathJax |

---

## 十、交付自检清单 (每次迭代必查)

- [ ] UI 文案全部 i18n（无硬编码中文）？
- [ ] 颜色全部来自 Paper `useTheme()`（无硬编码色值）？
- [ ] 严格遵守 UI → Hooks → Services 单向依赖？
- [ ] 数组/对象访问使用 `?.` / `??`（防闪退）？
- [ ] 新增/修改 API → 同步设计 toast + 错误码映射？
- [ ] TypeScript 无明显类型错误 / `any` 漫延？
- [ ] 更新 TODO（勾选已完成 + 补充遗留）？
- [ ] Android/iOS 兼容性确认（有差异必须写明）？

---

### 💡 Tips

1. **阶段 2 是当下最值得投入的**。错误处理 + 表单校验 + 防御性编程，直接决定"能不能给人用"。
2. **真机测试发现的问题优先修**。ROADMAP 是指导不是枷锁，真机反馈永远优先于计划。
3. **与后端同学保持接口文档同步**。前端的许多"待定"（AI 接口/多图/错误码结构）取决于后端进度。
4. **每个阶段不必 100% 完成再进下一个**。核心项做完即可推进，非核心项可跨阶段穿插完成。
